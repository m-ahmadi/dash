{"version":3,"sources":["../../../../src/js/widget/widget.js"],"names":["define","conf","token","mapMaker","manager","u","extend","newPubSub","temp","getTemps","extractor","KLASS_X1","join","KLASS_X2","KLASS_X3","KLASSES","DATE_FORMAT","jsonStr","JSON","stringify","jsonParse","parse","worker","init","Worker","ROOT","onmessage","d","e","data","emit","reqId","result","setGlobalTZ","userOffset","offset","Highcharts","setOptions","global","timezoneOffset","getDate","type","count","moment","subtract","format","getSensors","o","a","Object","keys","forEach","p","i","push","id","unit","genSeries","sensors","res","sensor","name","color","tooltip","valueDecimals","valueSuffix","units","filter","selected","genSeries2","k","makeBarChart","container","title","chart","align","text","style","fontSize","yAxis","series","rangeSelector","exporting","credits","legend","enabled","makeTitle","buildFormdata","FormData","append","updateTable","tEls","el","n","createPanel","parent","rangeTitle","expand","min","ctx","undefined","xOne","xTwo","xThree","map","html","panel","children","last","constructor","inst","w","root","els","startDate","endDate","xhr","updateNavigator","toggle","refresh","b","attr","disabled","TypeError","makeLineChart","stockChart","zoomType","navigator","adaptToUpdatedData","xAxis","events","setExtremes","DOMEvent","trigger","DOMType","max","loadGraphSensorData","body","menus","find","btnMax","is","slideUp","btnMin","slideDown","setSize","updateSize","curr","parseInt","inced","removeClass","toAdd","addClass","shrink","deced","mark","stat","keep","par","spinnerParent","markSuccess","markFail","setTimeout","spinnerOn","spinner","spinnerOff","cb","abort","showLoading","$","ajax","url","BASE","method","start_date","rangeType","rangeCount","end_date","device_ids","device","service_ids","service","kpis","done","forworker","action","rawData","postMessage","length","hideLoading","fail","x","status","always","loadStat","statOnly","contentType","processData","groups","group","statKpis","v","target","kpis_data","loadMapData","getData","load","getEls","on","get","setData","update","fillOpacity","dataGrouping","smoothed","lineWidth","marker","statTable","prepend","mapPopup","newMap","toSend","currentTarget","remove","menuBtn","mouseout","edit","destroy","obj","off","create"],"mappings":"AAAAA,OAAO,CACN,aADM,EAEN,YAFM,EAGN,YAHM,CAAP,EAIG,UAACC,IAAD,EAAOC,KAAP,EAAcC,QAAd,EAA2B;AAC7B,KAAMC,UAAUC,EAAEC,MAAF,CAAUC,WAAV,CAAhB;AACA,KAAMC,OAAOH,EAAEI,QAAF,CAAW,QAAX,CAAb;AACA,KAAMC,YAAYH,WAAlB;;AAEA,KAAMI,WAAW,CAChB,gBADgB,EAEhB,gBAFgB,EAGhB,gBAHgB,EAIhB,iBAJgB,EAKfC,IALe,CAKV,GALU,CAAjB;AAMA,KAAMC,WAAW,CAChB,gBADgB,EAEhB,gBAFgB,EAGhB,gBAHgB,EAIhB,iBAJgB,EAKfD,IALe,CAKV,GALU,CAAjB;AAMA,KAAME,WAAW,cAAjB;AACA,KAAMC,UAAaJ,QAAb,SAAyBE,QAAzB,SAAqCC,QAA3C;;AAEA,KAAME,cAAc,eAApB;AACA,KAAMC,UAAUC,KAAKC,SAArB;AACA,KAAMC,YAAYF,KAAKG,KAAvB;AACA,KAAIC,eAAJ;;AAEA,UAASC,IAAT,GAAgB;AACfD,WAAS,IAAIE,MAAJ,CAAWvB,KAAKwB,IAAL,GAAY,cAAvB,CAAT;AACAH,SAAOI,SAAP,GAAmB,aAAK;AACvB,OAAIC,IAAIC,EAAEC,IAAV;AACAnB,aAAUoB,IAAV,CAAeH,EAAEI,KAAjB,EAAwBJ,EAAEK,MAA1B;AACA,GAHD;AAIAC;AACA;;AAED,UAASA,WAAT,CAAqBC,UAArB,EAAiC;AAChC,MAAIC,SAASD,cAAc,KAA3B;AACAE,aAAWC,UAAX,CAAsB;AACrBC,WAAQ;AACPC,oBAAgB,CAACJ,MAAD,GAAU;AADnB;AADa,GAAtB;AAKA;AACD,UAASK,OAAT,CAAiBC,IAAjB,EAAuBC,KAAvB,EAA8B;AAC7B,MAAID,QAAQC,KAAZ,EAAmB;AAClB,UAAOC,SAASC,QAAT,CAAkBF,KAAlB,EAAyBD,IAAzB,EAA+BI,MAA/B,CAAsC7B,WAAtC,CAAP;AACA,GAFD,MAEO;AACN,UAAO2B,SAASE,MAAT,CAAgB7B,WAAhB,CAAP;AACA;AACD;AACD,UAAS8B,UAAT,CAAoBC,CAApB,EAAuB;AACtB,MAAIC,IAAI,EAAR;AACAC,SAAOC,IAAP,CAAYH,CAAZ,EAAeI,OAAf,CAAuB,aAAK;AAC3B,OAAIC,IAAIL,EAAEM,CAAF,CAAR;AACAL,KAAEM,IAAF,CAAO;AACNC,QAAIH,EAAEG,EADA;AAENC,UAAMJ,EAAEI;AAFF,IAAP;AAIA,GAND;AAOA,SAAOR,CAAP;AACA;AACD,UAASS,SAAT,CAAmBC,OAAnB,EAA4B;AAC3B;AACA,MAAIC,MAAM,EAAV;AACAV,SAAOC,IAAP,CAAYQ,OAAZ,EAAqBP,OAArB,CAA6B,aAAK;AACjC,OAAIS,SAASF,QAAQL,CAAR,CAAb;AACAM,OAAIL,IAAJ,CAAS;AACRC,QAAI,KAAGK,OAAOL,EADN;AAERd,UAAM,MAFE;AAGRoB,UAAMD,OAAOC,IAHL;AAIRC,WAAO,MAAKF,OAAOE,KAJX;AAKRjC,UAAM,EALE;AAMRkC,aAAS;AACRC,oBAAe,CADP;AAERC,kBAAa,MAAML,OAAOM,KAAP,CAAaC,MAAb,CAAoB;AAAA,aAAKpB,EAAEqB,QAAP;AAAA,MAApB,EAAqC,CAArC,EAAwCP;AAFnD;AAND,IAAT;AAWA,GAbD;AAcA,SAAOF,GAAP;AACA;AACD,UAASU,UAAT,CAAoBX,OAApB,EAA6B;AAC5B;AACA,MAAIC,MAAM,EAAV;AACAV,SAAOC,IAAP,CAAYQ,OAAZ,EAAqBP,OAArB,CAA6B,aAAK;AACjC,OAAIS,SAASF,QAAQY,CAAR,CAAb;AACAX,OAAIL,IAAJ,CAAS;AACRC,QAAIK,OAAOL,EADH;AAERM,UAAMD,OAAOC,IAFL;AAGRE,aAAS;AACRC,oBAAe;AADP,KAHD;AAMRnC,UAAM;AANE,IAAT;AAQA,GAVD;AAWA,SAAO8B,GAAP;AACA;AACD,UAASY,YAAT,CAAsBC,SAAtB,EAAiCC,KAAjC,EAAwCf,OAAxC,EAAiD;AAChD,SAAOtB,WAAWsC,KAAX,CAAiBF,UAAU,CAAV,CAAjB,EAA+B;AACrCE,UAAO;AACNjC,UAAM;AADA,IAD8B;AAIrCgC,UAAO;AACNE,WAAO,MADD;AAENC,UAAMH,SAAS,EAFT;AAGNI,WAAO;AACNf,YAAO,SADD;AAENgB,eAAU;AAFJ;AAHD,IAJ8B;AAYrCC,UAAO;AACNN,WAAO;AADD,IAZ8B;AAerCO,WAAQX,WAAWX,OAAX,CAf6B;AAgBrCuB,kBAAe,KAhBsB;AAiBrCC,cAAW,KAjB0B;AAkBrCC,YAAS,KAlB4B;AAmBrCC,WAAQ;AACPC,aAAS;AADF;AAnB6B,GAA/B,CAAP;AAuBA;AACD,UAASC,SAAT,CAAmB7C,IAAnB,EAAyB;AACxB,MAAIgC,cAAJ;AACA,UAAQhC,IAAR;AACC,QAAK,CAAL;AAAQgC,YAAQ,cAAR,CAA2B;AACnC,QAAK,CAAL;AAAQA,YAAQ,iBAAR,CAA2B;AACnC,QAAK,CAAL;AAAQA,YAAQ,MAAR,CAA0B;AAClC,QAAK,CAAL;AAAQA,YAAQ,KAAR,CAA2B;AAJpC;AAMA,SAAOA,KAAP;AACA;AACD,UAASc,aAAT,CAAuBxC,CAAvB,EAA0B;AACzB,MAAIY,MAAM,IAAI6B,QAAJ,EAAV;AACAvC,SAAOC,IAAP,CAAYH,CAAZ,EAAeI,OAAf,CAAuB,aAAK;AAC3BQ,OAAI8B,MAAJ,CAAWnB,CAAX,EAAcvB,EAAEuB,CAAF,CAAd;AACA,GAFD;AAGA,SAAOX,GAAP;AACA;AACD,UAAS+B,WAAT,CAAqB/D,CAArB,EAAwBgE,IAAxB,EAA8B;AAC7B1C,SAAOC,IAAP,CAAYvB,CAAZ,EAAewB,OAAf,CAAuB,aAAK;AAC3B,OAAIyC,KAAKD,KAAKrB,CAAL,CAAT;AACA,OAAIuB,IAAIlE,EAAE2C,CAAF,CAAR;AACAsB,MAAGhB,IAAH,CAAQiB,CAAR;AACA;;;;;AAKA,GATD;AAUA;AACD,UAASC,WAAT,CAAqBC,MAArB,EAA6BtD,IAA7B,EAAmCuD,UAAnC,EAA+CzC,EAA/C,EAAmD0C,MAAnD,EAA2DC,GAA3D,EAAgE;AAC/D,MAAMC,MAAM;AACX1B,UAAOa,UAAU7C,IAAV,CADI;AAEXuD,eAAYvD,SAAS,CAAT,GAAa2D,SAAb,GAAyBJ,UAF1B;AAGXzC,OAAIA,EAHO;AAIX8C,SAAMJ,WAAW,CAJN;AAKXK,SAAML,WAAW,CALN;AAMXM,WAAQN,WAAW,CANR;AAOXC,QAAKA,GAPM;AAQXM,QAAK/D,SAAS;AARH,GAAZ;AAUA,MAAMgE,OAAOjG,KAAKkG,KAAL,CAAWP,GAAX,CAAb;AACAJ,SAAON,MAAP,CAAcgB,IAAd;AACA,SAAOV,OAAOY,QAAP,GAAkBC,IAAlB,EAAP;AACA;;AAED,UAASC,WAAT,CAAqBrC,SAArB,EAAgCzB,CAAhC,EAAmC;AAClC,MAAM+D,OAAO,EAAb;AACA,MAAIC,IAAI,EAAR;AACA,MAAIC,aAAJ;AAAA,MAAUC,YAAV;AACA,MAAIvC,cAAJ;AACA,MAAIwC,kBAAJ;AAAA,MAAeC,gBAAf,CALkC,CAKV;AACxB,MAAIX,YAAJ;AACA,MAAIY,YAAJ;AACA,MAAIC,kBAAkB,IAAtB;AACA,MAAIC,SAAS;AACZC,UADY,mBACJC,CADI,EACD;AACVP,QAAIM,OAAJ,CAAYE,IAAZ,CAAiB,EAACC,UAAU,CAACF,CAAZ,EAAjB;AACA;AAHW,GAAb;;AAMA,MAAI,CAAChD,SAAD,IAAc,CAACzB,CAAnB,EAAsB;AACrB,SAAM,IAAI4E,SAAJ,CAAc,mDAAd,CAAN;AACA;AACDZ,MAAIhE,CAAJ;;AAEA,WAAS6E,aAAT,CAAuBpD,SAAvB,EAAkCC,KAAlC,EAAyCf,OAAzC,EAAkD;AACjD,UAAOtB,WAAWyF,UAAX,CAAsBrD,UAAU,CAAV,CAAtB,EAAoC;AAC1CS,mBAAe,KAD2B;AAE1CC,eAAW,KAF+B;AAG1CC,aAAS,KAHiC;AAI1CV,WAAO;AACNE,YAAO,MADD;AAENC,WAAMH,SAAS,EAFT;AAGNI,YAAO;AACNf,aAAO,SADD;AAENgB,gBAAU;AAFJ;AAHD,KAJmC;AAY1CJ,WAAO;AACNoD,eAAU;AACV;;;;;;;;;AAFM,KAZmC;AAwB1CC,eAAW;AACVC,yBAAoB;AADV,KAxB+B;AA2B1CC,WAAO;AACNC,aAAQ;AACPC,mBAAa,wBAAK;AACjB,WAAIxG,IAAIC,EAAEwG,QAAV;AACA,WAAIC,UAAUzG,EAAEyG,OAAhB;AACA,WAAM1G,KAAKA,EAAE2G,OAAF,KAAc,WAApB,IAAoCD,YAAY,MAArD,EAA8D;AAAE;AAC/DnB,oBAAYvE,OAAOf,EAAEsE,GAAT,EAAcrD,MAAd,CAAqB7B,WAArB,CAAZ;AACAmG,kBAAUxE,OAAOf,EAAE2G,GAAT,EAAc1F,MAAd,CAAqB7B,WAArB,CAAV;AACAwH;AACA;AACD;AATM;AADF,KA3BmC;AAwC1CpD,YAAQ;AACPC,cAAS;AADF,KAxCkC;AA2C1CL,YAAQvB,UAAUC,OAAV;AA3CkC,IAApC,CAAP;AA6CA;AACD,WAASwC,GAAT,GAAe;AACd,OAAIN,KAAKqB,IAAIwB,IAAb;AACAzB,QAAKnF,IAAL,CAAU,KAAV,EAAiB,IAAjB;AACAoF,OAAIyB,KAAJ,CAAUC,IAAV,CAAe,eAAf,EAAgClC,IAAhC,CAAsCjG,KAAKoI,MAAL,EAAtC;;AAEA,IAAChD,GAAGiD,EAAH,CAAM,WAAN,CAAD,GAAsBjD,GAAGkD,OAAH,CAAW,GAAX,EAAgB,YAAM;AAC3C;AACA,IAFqB,CAAtB,GAEK1C,SAFL;AAGA;AACD,WAASmC,GAAT,GAAe;AACd,OAAI3C,KAAKqB,IAAIwB,IAAb;AACAzB,QAAKnF,IAAL,CAAU,KAAV,EAAiB,KAAjB;AACAoF,OAAIyB,KAAJ,CAAUC,IAAV,CAAe,eAAf,EAAgClC,IAAhC,CAAsCjG,KAAKuI,MAAL,EAAtC;;AAEA,IAACnD,GAAGiD,EAAH,CAAM,WAAN,CAAD,GAAsBjD,GAAGoD,SAAH,CAAa,GAAb,EAAkB,YAAM;AAC7C,QAAItE,KAAJ,EAAWA,MAAMuE,OAAN;AACX,QAAIzC,GAAJ,EAASA,IAAIhC,SAAJ,CAAc0E,UAAd;AACT,IAHqB,CAAtB,GAGK9C,SAHL;AAIA;AACD,WAASH,MAAT,GAAkB;AACjB,OAAIkD,OAAOC,SAASpC,KAAKS,IAAL,CAAU,aAAV,CAAT,EAAmC,EAAnC,CAAX;AACA,OAAI4B,QAAQF,OAAO,CAAnB;AACA,OAAItD,IAAIwD,QAAQ,CAAR,GAAY,CAAZ,GACNA,QAAQ,CAAR,GAAY,CAAZ,GAAgBA,KADlB;AAEArC,QAAKS,IAAL,CAAU,aAAV,EAAyB5B,CAAzB;AACAmB,QAAKsC,WAAL,CAAiBvI,OAAjB;AACA,OAAIwI,cAAJ;AACA,WAAQJ,IAAR;AACC,SAAK,CAAL;AAAQI,aAAQ5I,QAAR,CAAkB;AAC1B,SAAK,CAAL;AAAQ4I,aAAQ1I,QAAR,CAAkB;AAC1B,SAAK,CAAL;AAAQ0I,aAAQzI,QAAR,CAAkB;AAC1B,SAAK,CAAL;AAAQyI,aAAQzI,QAAR,CAAkB;AAJ3B;AAMAkG,QAAKwC,QAAL,CAAcD,KAAd;AACA,OAAI7E,KAAJ,EAAWA,MAAMuE,OAAN;AACX,OAAKzC,OAAOS,IAAIwB,IAAJ,CAASI,EAAT,CAAY,UAAZ,CAAZ,EAAsCrC,IAAIhC,SAAJ,CAAc0E,UAAd;AACtC;AACD,WAASO,MAAT,GAAkB;AACjB,OAAIN,OAAOC,SAASpC,KAAKS,IAAL,CAAU,aAAV,CAAT,EAAmC,EAAnC,CAAX;AACA,OAAIiC,QAAQP,OAAO,CAAnB;AACA,OAAItD,IAAI6D,QAAQ,CAAR,GAAY,CAAZ,GACNA,QAAQ,CAAR,GAAY,CAAZ,GAAgBA,KADlB;AAEA1C,QAAKS,IAAL,CAAU,aAAV,EAAyB5B,CAAzB;AACAmB,QAAKsC,WAAL,CAAiBvI,OAAjB;AACA,OAAIwI,cAAJ;AACA,WAAQJ,IAAR;AACC,SAAK,CAAL;AAAQI,aAAQ,EAAR,CAAY;AACpB,SAAK,CAAL;AAAQA,aAAQ,EAAR,CAAY;AACpB,SAAK,CAAL;AAAQA,aAAQ5I,QAAR,CAAkB;AAC1B,SAAK,CAAL;AAAQ4I,aAAQ1I,QAAR,CAAkB;AAJ3B;AAMAmG,QAAKwC,QAAL,CAAcD,KAAd;AACA,OAAI7E,KAAJ,EAAWA,MAAMuE,OAAN;AACX,OAAKzC,OAAOS,IAAIwB,IAAJ,CAASI,EAAT,CAAY,UAAZ,CAAZ,EAAsCrC,IAAIhC,SAAJ,CAAc0E,UAAd;AACtC;AACD,WAASS,IAAT,CAAcC,IAAd,EAAoBC,IAApB,EAA0B;AACzB,OAAIC,MAAM7C,IAAI8C,aAAd;AACAD,OAAIrD,IAAJ,CAAS,QAAT;AACAqD,OAAIrE,MAAJ,CAAYmE,OAAOpJ,KAAKwJ,WAAL,EAAP,GAA4BxJ,KAAKyJ,QAAL,EAAxC;AACA,OAAI,CAACJ,IAAL,EAAW;AACVK,eAAW;AAAA,YAAMJ,IAAIrD,IAAJ,CAAS,QAAT,CAAN;AAAA,KAAX,EAAqC,IAArC;AACA;AACD;AACD,WAAS0D,SAAT,GAAqB;AACpB,OAAIL,MAAM7C,IAAI8C,aAAd;AACAD,OAAIrD,IAAJ,CAAS,QAAT;AACAqD,OAAIrE,MAAJ,CAAYjF,KAAK4J,OAAL,EAAZ;AACA;AACD,WAASC,UAAT,GAAsB;AACrBpD,OAAI8C,aAAJ,CAAkBtD,IAAlB,CAAuB,QAAvB;AACA;AACD,WAAS+B,mBAAT,CAA6B8B,EAA7B,EAAiC;AAChC,OAAIlD,GAAJ,EAAS;AACRA,QAAImD,KAAJ;AACAF;AACA;AACDF;AACA,OAAIzF,KAAJ,EAAWA,MAAM8F,WAAN;AACXpD,SAAMqD,EAAEC,IAAF,CAAO;AACZC,SAAK1K,KAAK2K,IAAL,GAAW,4BAAX,GAAyC1K,OADlC;AAEZ2K,YAAQ,MAFI;AAGZhJ,UAAM;AACLiJ,iBAAY5D,aAAa1E,QAAQuE,EAAEgE,SAAV,EAAqBhE,EAAEiE,UAAvB,CADpB;AAELC,eAAU9D,WAAW3E,SAFhB;AAGL0I,iBAAYjK,QAAS,CAAC8F,EAAEoE,MAAF,CAAS5H,EAAV,CAAT,CAHP;AAIL6H,kBAAanK,QAAS,CAAC8F,EAAEsE,OAAF,CAAU9H,EAAX,CAAT,CAJR;AAKL+H,WAAMrK,QAAS6B,WAAWiE,EAAErD,OAAb,CAAT;AALD;AAHM,IAAP,EAWL6H,IAXK,CAWA,gBAAQ;AACb,QAAIC,YAAY,EAACC,QAAQ,YAAT,EAAuB1J,OAAOgF,EAAExD,EAAhC,EAAoCmI,SAAS,EAA7C,EAAhB;AACA,QAAI,CAAC7J,IAAL,EAAW;AACVP,YAAOqK,WAAP,CAAmBH,SAAnB;AACA,KAFD,MAEO,IAAI3J,KAAK+J,MAAT,EAAiB;AACvBJ,eAAUE,OAAV,GAAoB7J,IAApB;AACAP,YAAOqK,WAAP,CAAmBH,SAAnB;AACA;AACDnB;AACAV,SAAK,IAAL;AACAjF,UAAMmH,WAAN;AACA,IAtBK,EAuBLC,IAvBK,CAuBA,aAAK;AACVzB;AACAV,SAAK,KAAL,EAAY,IAAZ;AACAjF,UAAMmH,WAAN;AACA;AACA,QAAIE,EAAEC,MAAF,KAAa,GAAjB,EAAsB5L,QAAQ0B,IAAR,CAAa,aAAb;AACtB,IA7BK,EA8BLmK,MA9BK,CA8BG;AAAA,WAAM3E,OAAOC,OAAP,CAAe,IAAf,CAAN;AAAA,IA9BH,CAAN;AA+BA;AACD,WAAS2E,QAAT,CAAkBC,QAAlB,EAA4B;AAC3BhC;AACA,OAAIzF,KAAJ,EAAWA,MAAM8F,WAAN;AACXC,KAAEC,IAAF,CAAO;AACNC,SAAK1K,KAAK2K,IAAL,GAAW,gBAAX,GAA6B1K,OAD5B;AAEN2K,YAAQ,MAFF;AAGNuB,iBAAa,KAHP,EAGa;AACnBC,iBAAa,KAJP;AAKNxK,UAAM0D,cAAc;AACnBuF,iBAAYtI,QAAQuE,EAAEgE,SAAV,EAAqBhE,EAAEiE,UAAvB,CADO;AAEnBC,eAAUzI,SAFS;AAGnB8J,aAAQrL,QAAS,CAAC8F,EAAEwF,KAAF,CAAQhJ,EAAT,CAAT,CAHW;AAInB+H,WAAMrK,QAAS8F,EAAEyF,QAAF,CAAWhG,GAAX,CAAe,aAAK;AAAC,aAAOiG,EAAE5I,IAAT;AAAc,MAAnC,CAAT;AAJa,KAAd;AALA,IAAP,EAYC0H,IAZD,CAYM,gBAAQ;AACb,QAAImB,SAAS7K,KAAK,CAAL,EAAQ8K,SAArB;AACA,QAAInB,YAAY;AACfC,aAAQU,WAAW,OAAX,GAAqB,WADd;AAEfpK,YAAOgF,EAAExD,EAFM;AAGfmI,cAASS,WAAWtK,KAAK,CAAL,CAAX,GAAqBA,KAAK,CAAL,EAAQ8K,SAHvB;AAIfH,eAAUzF,EAAEyF;AAJG,KAAhB;AAMAlL,WAAOqK,WAAP,CAAmBH,SAAnB;AACAnB;AACAV,SAAK,IAAL;AACA,QAAIjF,KAAJ,EAAWA,MAAMmH,WAAN;AACX,IAxBD,EAyBCC,IAzBD,CAyBM,aAAK;AACVzB;AACAV,SAAK,KAAL,EAAY,IAAZ;AACA,QAAIjF,KAAJ,EAAWA,MAAMmH,WAAN;AACX,QAAIE,EAAEC,MAAF,KAAa,GAAjB,EAAsB5L,QAAQ0B,IAAR,CAAa,aAAb;AACtB,IA9BD,EA+BCmK,MA/BD,CA+BS;AAAA,WAAM3E,OAAOC,OAAP,CAAe,IAAf,CAAN;AAAA,IA/BT;AAgCA;AACD,WAASqF,WAAT,GAAuB;AACtBpG,OAAIqG,OAAJ;AACA;AACD,WAASC,IAAT,GAAgB;AACf,WAAQ/F,EAAEtE,IAAV;AACC,SAAK,CAAL;AAAQ+F,2BAAuB;AAC/B,SAAK,CAAL;AAAQ0D,gBAAY;AACpB,SAAK,CAAL;AAAQA,cAAS,IAAT,EAAgB;AACxB,SAAK,CAAL;AAAQU,mBAAe;AAJxB;AAMA;AACD,WAASrL,IAAT,GAAgB;AACfyF,UAAOlB,YAAYtB,SAAZ,EAAuBuC,EAAEtE,IAAzB,EAA+BsE,EAAEf,UAAjC,EAA6Ce,EAAExD,EAA/C,EAAmDwD,EAAEd,MAArD,EAA6Dc,EAAEb,GAA/D,CAAP;AACAe,SAAM5G,EAAE0M,MAAF,CAAS/F,IAAT,CAAN;;AAEA;AACA,OAAMvE,OAAOsE,EAAEtE,IAAf;AACA,OAAIA,SAAS,CAAb,EAAgB;AACfiC,YAAQkD,cAAcX,IAAIzC,SAAlB,EAA6BuC,EAAEoE,MAAF,CAAStH,IAAtC,EAA4CkD,EAAErD,OAA9C,CAAR;AACAgB,UAAMuE,OAAN;;AAEAvI,cAAUsM,EAAV,CAAa,KAAGjG,EAAExD,EAAlB,EAAsB,aAAK;AAC1BN,YAAOC,IAAP,CAAYH,CAAZ,EAAeI,OAAf,CAAwB;AAAA,aAAKuB,MAAMuI,GAAN,CAAU3I,CAAV,EAAa4I,OAAb,CAAqBnK,EAAEuB,CAAF,CAArB,CAAL;AAAA,MAAxB;AACA,SAAI,CAAC+C,eAAL,EAAsB;AACtB3C,WAAMyI,MAAN,CAAa;AACZpF,iBAAW;AACV/C,eAAQ;AACPnD,cAAMkB,EAAGE,OAAOC,IAAP,CAAYH,CAAZ,EAAe,CAAf,CAAH,CADC;AAEPN,cAAM,YAFC;AAGPqB,eAAO,SAHA;AAIPsJ,qBAAa,IAJN;AAKPC,sBAAc;AACbC,mBAAU;AADG,SALP;AAQPC,mBAAW,CARJ;AASPC,gBAAQ;AACPnI,kBAAS;AADF;AATD;AADE;AADC,MAAb;AAiBAgC,uBAAkB,KAAlB;AACA,KArBD;AAsBA,IA1BD,MA0BO,IAAI5E,SAAS,CAAb,EAAgB;AACtBiC,YAAQH,aAAa0C,IAAIzC,SAAjB,EAA4BuC,EAAEwF,KAAF,CAAQ1I,IAApC,EAA0CkD,EAAEyF,QAA5C,CAAR;AACA9H,UAAMuE,OAAN;;AAEAvI,cAAUsM,EAAV,CAAa,KAAGjG,EAAExD,EAAlB,EAAsB,aAAK;AAC1B5B,OAAEwB,OAAF,CAAW;AAAA,aAAKuB,MAAMuI,GAAN,CAAU5J,EAAEE,EAAZ,EAAgB2J,OAAhB,CAAwB7J,EAAExB,IAA1B,CAAL;AAAA,MAAX;AACA,KAFD;AAGA,IAPM,MAOA,IAAIY,SAAS,CAAb,EAAgB;AACtB,QAAIgG,OAAOxB,IAAIwB,IAAf;AACAA,SAAKhC,IAAL,CAAWjG,KAAKiN,SAAL,CAAe,EAAChJ,OAAOsC,EAAEwF,KAAF,CAAQ1I,IAAhB,EAAsBmD,MAAM/G,KAAKwB,IAAjC,EAAf,CAAX;AACA,QAAIkE,OAAOtF,EAAE0M,MAAF,CAAUtE,IAAV,CAAX;AACA/H,cAAUsM,EAAV,CAAa,KAAGjG,EAAExD,EAAlB,EAAsBmC,WAAtB,EAAmCC,IAAnC;AACA,IALM,MAKA,IAAIlD,SAAS,CAAb,EAAgB;AACtBwE,QAAIwB,IAAJ,CAASiF,OAAT,CAAkBlN,KAAKmN,QAAL,EAAlB;AACAnH,UAAMrG,SAASyN,MAAT,EAAN;AACApH,QAAIkG,MAAJ,GAAazF,IAAIzC,SAAJ,CAAc,CAAd,CAAb;AACAgC,QAAI0B,MAAJ,CACE8E,EADF,CACK,aADL,EACoB,YAAM;AACxB5M,aAAQ0B,IAAR,CAAa,aAAb;AACA,KAHF,EAIEkL,EAJF,CAIK,YAJL,EAImB7C,SAJnB,EAKE6C,EALF,CAKK,WALL,EAKkB,YAAM;AACtB3C;AACAV,UAAK,IAAL;AACA,KARF,EASEqD,EATF,CASK,WATL,EASkB,YAAM;AACtB3C;AACAV,UAAK,KAAL;AACA,KAZF,EAaEqD,EAbF,CAaK,aAbL,EAaoB1F,OAAOC,OAb3B,EAaoC,IAbpC,EAcEyF,EAdF,CAcK,aAdL,EAcoB,YAAM,CAExB,CAhBF;AAiBAxG,QAAIqH,MAAJ,GAAa9G,EAAEP,GAAf;AACAA,QAAIjF,IAAJ,CAAS,KAAT;AACA;;AAED0F,OAAIyB,KAAJ,CAAUsE,EAAV,CAAa,OAAb,EAAsB,aAAtB,EAAqC,aAAK;AACzC,QAAIvB,SAAShB,EAAE7I,EAAE8K,MAAJ,EAAY7K,IAAZ,GAAmB4J,MAAnB,IAA6BhB,EAAE7I,EAAEkM,aAAJ,EAAmBjM,IAAnB,GAA0B4J,MAApE;AACCA,aAASrC,SAASqC,MAAT,EAAiB,EAAjB,CAAT;AACD,QAAIA,WAAW,CAAf,EAAkB;AACjBlD;AACA,KAFD,MAEO,IAAIkD,WAAW,CAAf,EAAkB;AACxBvF;AACA;AACD,IARD;AASAe,OAAIhB,MAAJ,CAAW+G,EAAX,CAAc,OAAd,EAAuB,YAAM;AAC5B/G;AACA,IAFD;AAGAgB,OAAIwC,MAAJ,CAAWuD,EAAX,CAAc,OAAd,EAAuB,YAAM;;AAE5BvD;AACA,IAHD;AAIAxC,OAAI8G,MAAJ,CAAWf,EAAX,CAAc,OAAd,EAAuB,YAAM;AAC5B/F,QAAI+G,OAAJ,CAAYC,QAAZ;AACA7N,YAAQ0B,IAAR,CAAa,QAAb,EAAuBiF,EAAExD,EAAzB;AACA,IAHD;AAIA0D,OAAIM,OAAJ,CAAYyF,EAAZ,CAAe,OAAf,EAAwB,aAAK;AAC5B,QAAIpL,EAAE8K,MAAF,CAAShF,QAAb,EAAuB;AACvBJ,WAAOC,OAAP,CAAe,KAAf;AACAuF;AACA,IAJD;AAKA7F,OAAIiH,IAAJ,CAASlB,EAAT,CAAY,OAAZ,EAAqB,YAAM;AAC1B/F,QAAI+G,OAAJ,CAAYC,QAAZ;AACA7N,YAAQ0B,IAAR,CAAa,MAAb,EAAqBiF,CAArB;AACA,IAHD;AAIA;;AAEDxF;AACAuL;;AAEAhG,OAAKpC,KAAL,GAAaA,KAAb;AACAoC,OAAK6C,IAAL,GAAYA,IAAZ;AACA7C,OAAKS,OAAL,GAAeuF,IAAf;AACAhG,OAAKZ,GAAL,GAAWA,GAAX;AACAY,OAAKyB,GAAL,GAAWA,GAAX;AACAzB,OAAKb,MAAL,GAAcA,MAAd;AACAa,OAAK2C,MAAL,GAAcA,MAAd;AACA3C,OAAKiH,MAAL,GAAc,YAAM;AACnB/G,QAAK+G,MAAL;AACA,OAAIrJ,KAAJ,EAAWA,MAAMyJ,OAAN;AACX,GAHD;AAIArH,OAAKqG,MAAL,GAAc,eAAO;AACpBpG,OAAIqH,GAAJ;AACAnH,OAAIxC,KAAJ,CAAUG,IAAV,CAAgBU,UAAUyB,EAAEtE,IAAZ,CAAhB;AACAwE,OAAIjB,UAAJ,CAAepB,IAAf,CAAqBmC,EAAEf,UAAvB;AACA,WAAQe,EAAEtE,IAAV;AACC,SAAK,CAAL;AAAQiC,aAAQkD,cAAcX,IAAIwB,IAAlB,EAAwB1B,EAAEoE,MAAF,CAAStH,IAAjC,EAAuCkD,EAAErD,OAAzC,CAAR,CAA2D;AACnE,SAAK,CAAL;AAAQgB,aAAQH,aAAa0C,IAAIwB,IAAjB,EAAuB1B,EAAEwF,KAAF,CAAQ1I,IAA/B,EAAqCkD,EAAEyF,QAAvC,CAAR,CAA0D;AAClE,SAAK,CAAL;AACCvF,SAAIwB,IAAJ,CAAShC,IAAT,CAAejG,KAAKiN,SAAL,CAAe,EAAChJ,OAAOsC,EAAEwF,KAAF,CAAQ1I,IAAhB,EAAsBmD,MAAM/G,KAAKwB,IAAjC,EAAf,CAAf;AACA,SAAIkE,OAAOtF,EAAE0M,MAAF,CAAU9F,IAAIwB,IAAd,CAAX;AACA/H,eACE2N,GADF,CACM,KAAGtH,EAAExD,EADX,EACemC,WADf,EAEEsH,EAFF,CAEK,KAAGjG,EAAExD,EAFV,EAEcmC,WAFd,EAE2BC,IAF3B;AAGA;AACD,SAAK,CAAL;AACCa,SAAIqH,MAAJ,GAAa9G,EAAEP,GAAf;AACAA,SAAIqG,OAAJ;AACA;AAbF;AAeAxF,qBAAkB,IAAlB;AACAyF;AACA,GArBD;;AAuBA1M,UAAQ0B,IAAR,CAAa,aAAb,EAA4BiF,EAAExD,EAA9B,EAAkCuD,IAAlC;AACA,SAAOA,IAAP;AACA;;AAGD1G,SAAQ6B,WAAR,GAAsBA,WAAtB;AACA7B,SAAQkO,MAAR,GAAiBzH,WAAjB;AACAzG,SAAQmB,IAAR,GAAeA,IAAf;;AAEA,QAAOnB,OAAP;AACA,CA5hBD","file":"widget.js","sourcesContent":["define([\r\n\t\"core/config\",\r\n\t\"core/token\",\r\n\t\"./mapMaker\"\r\n], (conf, token, mapMaker) => {\r\n\tconst manager = u.extend( newPubSub() );\r\n\tconst temp = u.getTemps(\"widget\");\r\n\tconst extractor = newPubSub();\r\n\t\r\n\tconst KLASS_X1 = [\r\n\t\t\"uk-width-1-1@s\",\r\n\t\t\"uk-width-1-1@m\",\r\n\t\t\"uk-width-1-2@l\",\r\n\t\t\"uk-width-1-2@xl\"\r\n\t].join(\" \");\r\n\tconst KLASS_X2 = [\r\n\t\t\"uk-width-1-1@s\",\r\n\t\t\"uk-width-1-1@m\",\r\n\t\t\"uk-width-2-3@l\",\r\n\t\t\"uk-width-3-4@xl\"\r\n\t].join(\" \");\r\n\tconst KLASS_X3 = \"uk-width-1-1\";\r\n\tconst KLASSES = `${KLASS_X1} ${KLASS_X2} ${KLASS_X3}`;\r\n\t\r\n\tconst DATE_FORMAT = \"Y/MM/DD HH:mm\";\r\n\tconst jsonStr = JSON.stringify;\r\n\tconst jsonParse = JSON.parse;\r\n\tlet worker;\r\n\t\r\n\tfunction init() {\r\n\t\tworker = new Worker(conf.ROOT + \"js/worker.js\");\r\n\t\tworker.onmessage = e => {\r\n\t\t\tlet d = e.data;\r\n\t\t\textractor.emit(d.reqId, d.result);\r\n\t\t};\r\n\t\tsetGlobalTZ();\r\n\t}\r\n\t\r\n\tfunction setGlobalTZ(userOffset) {\r\n\t\tlet offset = userOffset || 16200;\r\n\t\tHighcharts.setOptions({\r\n\t\t\tglobal: {\r\n\t\t\t\ttimezoneOffset: -offset / 60\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\tfunction getDate(type, count) {\r\n\t\tif (type && count) {\r\n\t\t\treturn moment().subtract(count, type).format(DATE_FORMAT);\r\n\t\t} else {\r\n\t\t\treturn moment().format(DATE_FORMAT);\r\n\t\t}\r\n\t}\r\n\tfunction getSensors(o) {\r\n\t\tlet a = [];\r\n\t\tObject.keys(o).forEach(i => {\r\n\t\t\tlet p = o[i];\r\n\t\t\ta.push({\r\n\t\t\t\tid: p.id,\r\n\t\t\t\tunit: p.unit\r\n\t\t\t});\r\n\t\t});\r\n\t\treturn a;\r\n\t}\r\n\tfunction genSeries(sensors) {\r\n\t\t// for line charts\r\n\t\tlet res = [];\r\n\t\tObject.keys(sensors).forEach(i => {\r\n\t\t\tlet sensor = sensors[i];\r\n\t\t\tres.push({\r\n\t\t\t\tid: \"\"+sensor.id,\r\n\t\t\t\ttype: \"line\",\r\n\t\t\t\tname: sensor.name,\r\n\t\t\t\tcolor: \"#\"+ sensor.color,\r\n\t\t\t\tdata: [],\r\n\t\t\t\ttooltip: {\r\n\t\t\t\t\tvalueDecimals: 2,\r\n\t\t\t\t\tvalueSuffix: \" \" + sensor.units.filter(o => o.selected)[0].name\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t\treturn res;\r\n\t}\r\n\tfunction genSeries2(sensors) {\r\n\t\t// for bar charts\r\n\t\tlet res = [];\r\n\t\tObject.keys(sensors).forEach(k => {\r\n\t\t\tlet sensor = sensors[k];\r\n\t\t\tres.push({\r\n\t\t\t\tid: sensor.id,\r\n\t\t\t\tname: sensor.name,\r\n\t\t\t\ttooltip: {\r\n\t\t\t\t\tvalueDecimals: 2\r\n\t\t\t\t},\r\n\t\t\t\tdata: []\r\n\t\t\t});\r\n\t\t});\r\n\t\treturn res;\r\n\t}\r\n\tfunction makeBarChart(container, title, sensors) {\r\n\t\treturn Highcharts.chart(container[0], {\r\n\t\t\tchart: {\r\n\t\t\t\ttype: \"column\"\r\n\t\t\t},\r\n\t\t\ttitle: {\r\n\t\t\t\talign: \"left\",\r\n\t\t\t\ttext: title || \"\",\r\n\t\t\t\tstyle: {\r\n\t\t\t\t\tcolor: \"#717171\",\r\n\t\t\t\t\tfontSize: \"14px\"\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\tyAxis: {\r\n\t\t\t\ttitle: false\r\n\t\t\t},\r\n\t\t\tseries: genSeries2(sensors),\r\n\t\t\trangeSelector: false,\r\n\t\t\texporting: false,\r\n\t\t\tcredits: false,\r\n\t\t\tlegend: {\r\n\t\t\t\tenabled: true\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\tfunction makeTitle(type) {\r\n\t\tlet title;\r\n\t\tswitch (type) {\r\n\t\t\tcase 0: title = \"Graph Sensor\";    break;\r\n\t\t\tcase 1: title = \"Violation Ratio\"; break;\r\n\t\t\tcase 2: title = \"Stat\";           break;\r\n\t\t\tcase 3: title = \"Map\";             break;\r\n\t\t}\r\n\t\treturn title;\r\n\t}\r\n\tfunction buildFormdata(o) {\r\n\t\tlet res = new FormData();\r\n\t\tObject.keys(o).forEach(k => {\r\n\t\t\tres.append(k, o[k]);\r\n\t\t});\r\n\t\treturn res;\r\n\t}\r\n\tfunction updateTable(d, tEls) {\r\n\t\tObject.keys(d).forEach(k => {\r\n\t\t\tlet el = tEls[k];\r\n\t\t\tlet n = d[k];\r\n\t\t\tel.text(n);\r\n\t\t\t/* switch (true) {\r\n\t\t\t\tcase (n < 10):          el.addClass(\"green-text\");  break;\r\n\t\t\t\tcase (n > 10 && n< 30): el.addClass(\"orange-text\"); break;\r\n\t\t\t\tcase (n > 30):          el.addClass(\"red-text\");    break;\r\n\t\t\t} */\r\n\t\t});\r\n\t}\r\n\tfunction createPanel(parent, type, rangeTitle, id, expand, min) {\r\n\t\tconst ctx = {\r\n\t\t\ttitle: makeTitle(type),\r\n\t\t\trangeTitle: type === 3 ? undefined : rangeTitle,\r\n\t\t\tid: id,\r\n\t\t\txOne: expand === 1,\r\n\t\t\txTwo: expand === 2,\r\n\t\t\txThree: expand === 3,\r\n\t\t\tmin: min,\r\n\t\t\tmap: type === 3\r\n\t\t};\r\n\t\tconst html = temp.panel(ctx);\r\n\t\tparent.append(html);\r\n\t\treturn parent.children().last();\r\n\t}\r\n\t\r\n\tfunction constructor(container, o) {\r\n\t\tconst inst = {};\r\n\t\tlet w = {};\r\n\t\tlet\troot, els;\r\n\t\tlet\tchart;\r\n\t\tlet startDate, endDate; // for customized ranges\r\n\t\tlet map;\r\n\t\tlet xhr;\r\n\t\tlet updateNavigator = true;\r\n\t\tlet toggle = {\r\n\t\t\trefresh(b) {\r\n\t\t\t\tels.refresh.attr({disabled: !b});\r\n\t\t\t}\r\n\t\t};\r\n\t\t\r\n\t\tif (!container || !o) {\r\n\t\t\tthrow new TypeError(\"You must provide a container and a widget object.\");\r\n\t\t}\r\n\t\tw = o;\r\n\t\t\r\n\t\tfunction makeLineChart(container, title, sensors) {\r\n\t\t\treturn Highcharts.stockChart(container[0], {\r\n\t\t\t\trangeSelector: false,\r\n\t\t\t\texporting: false,\r\n\t\t\t\tcredits: false,\r\n\t\t\t\ttitle: {\r\n\t\t\t\t\talign: \"left\",\r\n\t\t\t\t\ttext: title || \"\",\r\n\t\t\t\t\tstyle: {\r\n\t\t\t\t\t\tcolor: \"#717171\",\r\n\t\t\t\t\t\tfontSize: \"14px\"\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n\t\t\t\tchart: {\r\n\t\t\t\t\tzoomType: \"x\"\r\n\t\t\t\t\t/* resetZoomButton: { // works only with Highcharts.chart\r\n\t\t\t\t\t\trelativeTo: \"chart\",\r\n\t\t\t\t\t\tposition: {\r\n\t\t\t\t\t\t\talign: \"right\",\r\n\t\t\t\t\t\t\tverticalAlign: \"top\",\r\n\t\t\t\t\t\t\tx: 0,\r\n\t\t\t\t\t\t\ty: 0\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} */\r\n\t\t\t\t},\r\n\t\t\t\tnavigator: {\r\n\t\t\t\t\tadaptToUpdatedData: false\r\n\t\t\t\t},\r\n\t\t\t\txAxis: {\r\n\t\t\t\t\tevents: {\r\n\t\t\t\t\t\tsetExtremes: e => {\r\n\t\t\t\t\t\t\tlet d = e.DOMEvent;\r\n\t\t\t\t\t\t\tlet trigger = e.trigger;\r\n\t\t\t\t\t\t\tif ( (d && d.DOMType !== \"mousemove\") || trigger === \"zoom\" ) { // drag-end or zoom\r\n\t\t\t\t\t\t\t\tstartDate = moment(e.min).format(DATE_FORMAT);\r\n\t\t\t\t\t\t\t\tendDate = moment(e.max).format(DATE_FORMAT);\r\n\t\t\t\t\t\t\t\tloadGraphSensorData();\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n\t\t\t\tlegend: {\r\n\t\t\t\t\tenabled: true\r\n\t\t\t\t},\r\n\t\t\t\tseries: genSeries(sensors)\r\n\t\t\t});\r\n\t\t}\r\n\t\tfunction min() {\r\n\t\t\tlet el = els.body;\r\n\t\t\troot.data(\"min\", true);\r\n\t\t\tels.menus.find(\"[data-resize]\").html( temp.btnMax() );\r\n\t\t\t\r\n\t\t\t!el.is(\":animated\") ? el.slideUp(400, () => {\r\n\t\t\t\t// if (chart) chart.setSize();\r\n\t\t\t}) : undefined;\r\n\t\t}\r\n\t\tfunction max() {\r\n\t\t\tlet el = els.body;\r\n\t\t\troot.data(\"min\", false);\r\n\t\t\tels.menus.find(\"[data-resize]\").html( temp.btnMin() );\r\n\t\t\t\r\n\t\t\t!el.is(\":animated\") ? el.slideDown(400, () => {\r\n\t\t\t\tif (chart) chart.setSize();\r\n\t\t\t\tif (map) map.container.updateSize();\r\n\t\t\t}) : undefined;\r\n\t\t}\r\n\t\tfunction expand() {\r\n\t\t\tlet curr = parseInt(root.attr(\"data-expand\"), 10);\r\n\t\t\tlet inced = curr + 1;\r\n\t\t\tlet n = inced > 3 ? 3 :\r\n\t\t\t\t\tinced < 0 ? 0 : inced;\r\n\t\t\troot.attr(\"data-expand\", n);\r\n\t\t\troot.removeClass(KLASSES);\r\n\t\t\tlet toAdd;\r\n\t\t\tswitch (curr) {\r\n\t\t\t\tcase 0: toAdd = KLASS_X1; break;\r\n\t\t\t\tcase 1: toAdd = KLASS_X2; break;\r\n\t\t\t\tcase 2: toAdd = KLASS_X3; break;\r\n\t\t\t\tcase 3: toAdd = KLASS_X3; break;\r\n\t\t\t}\r\n\t\t\troot.addClass(toAdd);\r\n\t\t\tif (chart) chart.setSize();\r\n\t\t\tif ( map && els.body.is(\":visible\") ) map.container.updateSize();\r\n\t\t}\r\n\t\tfunction shrink() {\r\n\t\t\tlet curr = parseInt(root.attr(\"data-expand\"), 10);\r\n\t\t\tlet deced = curr - 1;\r\n\t\t\tlet n = deced > 3 ? 3 :\r\n\t\t\t\t\tdeced < 0 ? 0 : deced;\r\n\t\t\troot.attr(\"data-expand\", n);\r\n\t\t\troot.removeClass(KLASSES);\r\n\t\t\tlet toAdd;\r\n\t\t\tswitch (curr) {\r\n\t\t\t\tcase 0: toAdd = \"\"; break;\r\n\t\t\t\tcase 1: toAdd = \"\"; break;\r\n\t\t\t\tcase 2: toAdd = KLASS_X1; break;\r\n\t\t\t\tcase 3: toAdd = KLASS_X2; break;\r\n\t\t\t}\r\n\t\t\troot.addClass(toAdd);\r\n\t\t\tif (chart) chart.setSize();\r\n\t\t\tif ( map && els.body.is(\":visible\") ) map.container.updateSize();\r\n\t\t}\r\n\t\tfunction mark(stat, keep) {\r\n\t\t\tlet par = els.spinnerParent;\r\n\t\t\tpar.html(\"&nbsp;\");\r\n\t\t\tpar.append( stat ? temp.markSuccess() : temp.markFail() );\r\n\t\t\tif (!keep) {\r\n\t\t\t\tsetTimeout(() => par.html(\"&nbsp;\"), 1200);\r\n\t\t\t}\r\n\t\t}\r\n\t\tfunction spinnerOn() {\r\n\t\t\tlet par = els.spinnerParent;\r\n\t\t\tpar.html(\"&nbsp;\");\r\n\t\t\tpar.append( temp.spinner() );\r\n\t\t}\r\n\t\tfunction spinnerOff() {\r\n\t\t\tels.spinnerParent.html(\"&nbsp;\");\r\n\t\t}\r\n\t\tfunction loadGraphSensorData(cb) {\r\n\t\t\tif (xhr) {\r\n\t\t\t\txhr.abort();\r\n\t\t\t\tspinnerOff();\r\n\t\t\t}\r\n\t\t\tspinnerOn();\r\n\t\t\tif (chart) chart.showLoading();\r\n\t\t\txhr = $.ajax({\r\n\t\t\t\turl: conf.BASE +\"device/devicekpisensordata\"+ token(),\r\n\t\t\t\tmethod: \"POST\",\r\n\t\t\t\tdata: {\r\n\t\t\t\t\tstart_date: startDate || getDate(w.rangeType, w.rangeCount),\r\n\t\t\t\t\tend_date: endDate || getDate(),\r\n\t\t\t\t\tdevice_ids: jsonStr( [w.device.id] ),\r\n\t\t\t\t\tservice_ids: jsonStr( [w.service.id] ),\r\n\t\t\t\t\tkpis: jsonStr( getSensors(w.sensors) )\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t\t.done(data => {\r\n\t\t\t\tlet forworker = {action: \"line_chart\", reqId: w.id, rawData: []};\r\n\t\t\t\tif (!data) {\r\n\t\t\t\t\tworker.postMessage(forworker);\r\n\t\t\t\t} else if (data.length) {\r\n\t\t\t\t\tforworker.rawData = data;\r\n\t\t\t\t\tworker.postMessage(forworker);\r\n\t\t\t\t}\r\n\t\t\t\tspinnerOff();\r\n\t\t\t\tmark(true);\r\n\t\t\t\tchart.hideLoading();\r\n\t\t\t})\r\n\t\t\t.fail(x => {\r\n\t\t\t\tspinnerOff();\r\n\t\t\t\tmark(false, true);\r\n\t\t\t\tchart.hideLoading();\r\n\t\t\t\t// root.children().first().prepend( temp.alert({message: \"Couldn't fetch widget data.\"}) );\r\n\t\t\t\tif (x.status === 403) manager.emit(\"login_error\");\r\n\t\t\t})\r\n\t\t\t.always( () => toggle.refresh(true) );\r\n\t\t}\r\n\t\tfunction loadStat(statOnly) {\r\n\t\t\tspinnerOn();\r\n\t\t\tif (chart) chart.showLoading();\r\n\t\t\t$.ajax({\r\n\t\t\t\turl: conf.BASE +\"stat/violation\"+ token(),\r\n\t\t\t\tmethod: \"POST\",\r\n\t\t\t\tcontentType: false,// \"multipart/form-data\",\r\n\t\t\t\tprocessData: false,\r\n\t\t\t\tdata: buildFormdata({\r\n\t\t\t\t\tstart_date: getDate(w.rangeType, w.rangeCount),\r\n\t\t\t\t\tend_date: getDate(),\r\n\t\t\t\t\tgroups: jsonStr( [w.group.id] ),\r\n\t\t\t\t\tkpis: jsonStr( w.statKpis.map(v => {return v.name}) )\r\n\t\t\t\t})\r\n\t\t\t})\r\n\t\t\t.done(data => {\r\n\t\t\t\tlet target = data[0].kpis_data;\r\n\t\t\t\tlet forworker = {\r\n\t\t\t\t\taction: statOnly ? \"table\" : \"bar_chart\",\r\n\t\t\t\t\treqId: w.id,\r\n\t\t\t\t\trawData: statOnly ? data[0] : data[0].kpis_data,\r\n\t\t\t\t\tstatKpis: w.statKpis\r\n\t\t\t\t};\r\n\t\t\t\tworker.postMessage(forworker);\r\n\t\t\t\tspinnerOff();\r\n\t\t\t\tmark(true);\r\n\t\t\t\tif (chart) chart.hideLoading();\r\n\t\t\t})\r\n\t\t\t.fail(x => {\r\n\t\t\t\tspinnerOff();\r\n\t\t\t\tmark(false, true);\r\n\t\t\t\tif (chart) chart.hideLoading();\r\n\t\t\t\tif (x.status === 403) manager.emit(\"login_error\");\r\n\t\t\t})\r\n\t\t\t.always( () => toggle.refresh(true) );\r\n\t\t}\r\n\t\tfunction loadMapData() {\r\n\t\t\tmap.getData();\r\n\t\t}\r\n\t\tfunction load() {\r\n\t\t\tswitch (w.type) {\r\n\t\t\t\tcase 0: loadGraphSensorData(); break;\r\n\t\t\t\tcase 1: loadStat(); break;\r\n\t\t\t\tcase 2: loadStat(true); break;\r\n\t\t\t\tcase 3: loadMapData(); break;\r\n\t\t\t}\r\n\t\t}\r\n\t\tfunction init() {\r\n\t\t\troot = createPanel(container, w.type, w.rangeTitle, w.id, w.expand, w.min);\r\n\t\t\tels = u.getEls(root);\r\n\t\t\t\r\n\t\t\t// when creating dom stuff.\r\n\t\t\tconst type = w.type;\r\n\t\t\tif (type === 0) {\r\n\t\t\t\tchart = makeLineChart(els.container, w.device.name, w.sensors);\r\n\t\t\t\tchart.setSize();\r\n\t\t\t\t\r\n\t\t\t\textractor.on(\"\"+w.id, o => {\r\n\t\t\t\t\tObject.keys(o).forEach( k => chart.get(k).setData(o[k]) );\r\n\t\t\t\t\tif (!updateNavigator) return;\r\n\t\t\t\t\tchart.update({\r\n\t\t\t\t\t\tnavigator: {\r\n\t\t\t\t\t\t\tseries: {\r\n\t\t\t\t\t\t\t\tdata: o[ Object.keys(o)[0] ],\r\n\t\t\t\t\t\t\t\ttype: 'areaspline',\r\n\t\t\t\t\t\t\t\tcolor: '#4572A7',\r\n\t\t\t\t\t\t\t\tfillOpacity: 0.05,\r\n\t\t\t\t\t\t\t\tdataGrouping: {\r\n\t\t\t\t\t\t\t\t\tsmoothed: true\r\n\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\tlineWidth: 1,\r\n\t\t\t\t\t\t\t\tmarker: {\r\n\t\t\t\t\t\t\t\t\tenabled: false\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t\tupdateNavigator = false;\r\n\t\t\t\t});\r\n\t\t\t} else if (type === 1) {\r\n\t\t\t\tchart = makeBarChart(els.container, w.group.name, w.statKpis);\r\n\t\t\t\tchart.setSize();\r\n\t\t\t\t\r\n\t\t\t\textractor.on(\"\"+w.id, d => {\r\n\t\t\t\t\td.forEach( i => chart.get(i.id).setData(i.data) );\r\n\t\t\t\t});\r\n\t\t\t} else if (type === 2) {\r\n\t\t\t\tlet body = els.body;\r\n\t\t\t\tbody.html( temp.statTable({title: w.group.name, root: conf.ROOT}) );\r\n\t\t\t\tlet tEls = u.getEls( body );\r\n\t\t\t\textractor.on(\"\"+w.id, updateTable, tEls);\r\n\t\t\t} else if (type === 3) {\r\n\t\t\t\tels.body.prepend( temp.mapPopup() );\r\n\t\t\t\tmap = mapMaker.newMap();\r\n\t\t\t\tmap.target = els.container[0];\r\n\t\t\t\tmap.events\r\n\t\t\t\t\t.on(\"login_error\", () => {\r\n\t\t\t\t\t\tmanager.emit(\"login_error\");\r\n\t\t\t\t\t})\r\n\t\t\t\t\t.on(\"data_start\", spinnerOn)\r\n\t\t\t\t\t.on(\"data_succ\", () => {\r\n\t\t\t\t\t\tspinnerOff();\r\n\t\t\t\t\t\tmark(true);\r\n\t\t\t\t\t})\r\n\t\t\t\t\t.on(\"data_fail\", () => {\r\n\t\t\t\t\t\tspinnerOff();\r\n\t\t\t\t\t\tmark(false);\r\n\t\t\t\t\t})\r\n\t\t\t\t\t.on(\"data_always\", toggle.refresh, true)\r\n\t\t\t\t\t.on(\"detail_fail\", () => {\r\n\t\t\t\t\t\r\n\t\t\t\t\t});\r\n\t\t\t\tmap.toSend = w.map;\r\n\t\t\t\tmap.init(false);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tels.menus.on(\"click\", \"[data-menu]\", e => {\r\n\t\t\t\tlet action = $(e.target).data().action || $(e.currentTarget).data().action;\r\n\t\t\t\t\taction = parseInt(action, 10);\r\n\t\t\t\tif (action === 0) {\r\n\t\t\t\t\tmax();\r\n\t\t\t\t} else if (action === 1) {\r\n\t\t\t\t\tmin();\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\tels.expand.on(\"click\", () => {\r\n\t\t\t\texpand();\r\n\t\t\t});\r\n\t\t\tels.shrink.on(\"click\", () => {\r\n\t\t\t\t\r\n\t\t\t\tshrink();\r\n\t\t\t});\r\n\t\t\tels.remove.on(\"click\", () => {\r\n\t\t\t\tels.menuBtn.mouseout();\r\n\t\t\t\tmanager.emit(\"delete\", w.id);\r\n\t\t\t});\r\n\t\t\tels.refresh.on(\"click\", e => {\r\n\t\t\t\tif (e.target.disabled) return;\r\n\t\t\t\ttoggle.refresh(false);\r\n\t\t\t\tload();\r\n\t\t\t});\r\n\t\t\tels.edit.on(\"click\", () => {\r\n\t\t\t\tels.menuBtn.mouseout();\r\n\t\t\t\tmanager.emit(\"edit\", w);\r\n\t\t\t});\r\n\t\t}\r\n\t\t\r\n\t\tinit();\r\n\t\tload();\r\n\t\t\r\n\t\tinst.chart = chart;\r\n\t\tinst.mark = mark;\r\n\t\tinst.refresh = load;\r\n\t\tinst.min = min;\r\n\t\tinst.max = max;\r\n\t\tinst.expand = expand;\r\n\t\tinst.shrink = shrink;\r\n\t\tinst.remove = () => {\r\n\t\t\troot.remove();\r\n\t\t\tif (chart) chart.destroy();\r\n\t\t};\r\n\t\tinst.update = obj => {\r\n\t\t\tw = obj;\r\n\t\t\tels.title.text( makeTitle(w.type) );\r\n\t\t\tels.rangeTitle.text( w.rangeTitle );\r\n\t\t\tswitch (w.type) {\r\n\t\t\t\tcase 0: chart = makeLineChart(els.body, w.device.name, w.sensors); break;\r\n\t\t\t\tcase 1: chart = makeBarChart(els.body, w.group.name, w.statKpis); break;\r\n\t\t\t\tcase 2:\r\n\t\t\t\t\tels.body.html( temp.statTable({title: w.group.name, root: conf.ROOT}) );\r\n\t\t\t\t\tlet tEls = u.getEls( els.body );\r\n\t\t\t\t\textractor\r\n\t\t\t\t\t\t.off(\"\"+w.id, updateTable)\r\n\t\t\t\t\t\t.on(\"\"+w.id, updateTable, tEls);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase 3:\r\n\t\t\t\t\tmap.toSend = w.map;\r\n\t\t\t\t\tmap.getData();\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\tupdateNavigator = true;\r\n\t\t\tload();\r\n\t\t};\r\n\t\t\r\n\t\tmanager.emit(\"create_node\", w.id, inst);\r\n\t\treturn inst;\r\n\t}\r\n\t\r\n\t\r\n\tmanager.setGlobalTZ = setGlobalTZ ;\r\n\tmanager.create = constructor;\r\n\tmanager.init = init;\r\n\t\r\n\treturn manager;\r\n});"]}
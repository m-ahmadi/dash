{"version":3,"sources":["../../../../src/js/widget/mapMaker.js"],"names":["define","conf","token","inst","buildFormdata","o","res","FormData","Object","keys","forEach","append","k","newMap","events","newPubSub","toSend","undefined","target","container","center","coordinates","lastDevicePosition","last","zoom","isViolated","live","autoRefresh","interval","defaultCircuitID","view","ol","View","maxZoom","minZoom","violationLayer","layer","Vector","deviceLayer","layers","circuit","info","minor","major","critical","violationSource","source","wrapX","deviceSource","sources","violationStyle","feature","resolution","style","Style","text","Text","font","get","fill","Fill","color","stroke","Stroke","width","deviceStyle","image","Icon","src","ROOT","scale","opacity","lineStyle","type","self","colorMap","refreshMap","clearInterval","setInterval","getData","addDataToMap","data","clear","getFeatures","length","device","node","isSeleced","proj","transform","longtitude","latitude","addFeature","Feature","geometry","geom","Point","name","id","location","lat","long","selected","$","each","key","sourceXY","destinationXY","circuits","violatedServices","list","link","source_name","filterViolatedServices","destination","destination_name","sla_violated","sla_violated_type","push","maxLong","minLong","maxLat","minLat","LineString","alias","redraw","setCenter","trigger","timer","that","$center","$zoom","map","clearTimeout","setTimeout","bounce","animation","getResolution","pan","getCenter","beforeRender","getZoom","setZoom","fit","getSize","groups","service","assigned","coordinate","pixel","getPixelFromCoordinate","group","services","index","getCoordinateFromPixel","setStyle","addTooltip","document","getElementById","content_element","closer","visibility","onclick","closeTooltip","overlay","setPosition","blur","Overlay","element","autoPan","offset","addOverlay","on","event","devicesInPixel","circuitsInPixel","forEachFeatureAtPixel","coord","getGeometry","getCoordinates","content","features","innerHTML","getDevice","evt","details","contex","split","Number","ajax","url","BASE","method","done","detail","Critical","Major","Minor","Info","SerialNumber","HardwareVersion","SnmpLastSeenDate","CsvLastSeenDate","fail","x","status","emit","getCircuit","circuitID","$location","path","addPanel","fullscreen","control","FullScreen","addControl","zoomEvent","lastZoomLevel","setPointer","dragging","isDevice","getTarget","cursor","params","page","allowClear","loop","d","devices","group_ids","JSON","stringify","device_ids","violated","contentType","processData","total_pages","always","makeMap","Tile","OSM","setSource","Map","controls","defaults","attributionOptions","collapsible","setZIndex","init","load"],"mappings":"AAAAA,OAAO,CAAC,aAAD,EAAgB,YAAhB,CAAP,EAAsC,UAACC,IAAD,EAAOC,KAAP,EAAiB;AACtD,KAAMC,OAAO,EAAb;;AAEA,UAASC,aAAT,CAAuBC,CAAvB,EAA0B;AACzB,MAAIC,MAAM,IAAIC,QAAJ,EAAV;AACAC,SAAOC,IAAP,CAAYJ,CAAZ,EAAeK,OAAf,CAAuB,aAAK;AAC3BJ,OAAIK,MAAJ,CAAWC,CAAX,EAAcP,EAAEO,CAAF,CAAd;AACA,GAFD;AAGA,SAAON,GAAP;AACA;;AAED,UAASO,MAAT,GAAkB;AACjB,SAAO;AACNC,WAAQC,WADF;AAENC,WAAQC,SAFF;;AAINC,WAAQD,SAJF;AAKNE,cAAWF,SALL;AAMNG,WAAQH,SANF;AAONI,gBAAaJ,SAPP;AAQNK,uBAAoB,CAAC,CAAD,EAAI,CAAJ,CARd;AASNC,SAAM;AACLH,YAAQ,CAAC,CAAD,EAAI,CAAJ,CADH;AAELI,UAAM;AAFD,IATA;AAaNC,eAAY,KAbN;AAcNC,SAAM,IAdA;AAeNC,gBAAa,KAfP;AAgBNC,aAAUX,SAhBJ;AAiBNY,qBAAkBZ,SAjBZ,EAiBuB;AAC7Ba,SAAM,IAAIC,GAAGC,IAAP,CAAY;AACjBR,UAAM,CADW;AAEjBS,aAAS,EAFQ;AAGjBC,aAAS,GAHQ;AAIjBd,YAAQ,CAAC,CAAD,EAAI,CAAJ;AAJS,IAAZ,CAlBA;AAwBNe,mBAAgB,IAAIJ,GAAGK,KAAH,CAASC,MAAb,EAxBV;AAyBNC,gBAAa,IAAIP,GAAGK,KAAH,CAASC,MAAb,EAzBP;AA0BNE,WAAQ;AACPC,aAAS,IAAIT,GAAGK,KAAH,CAASC,MAAb,EADF;AAEPI,UAAM,IAAIV,GAAGK,KAAH,CAASC,MAAb,EAFC;AAGPK,WAAO,IAAIX,GAAGK,KAAH,CAASC,MAAb,EAHA;AAIPM,WAAO,IAAIZ,GAAGK,KAAH,CAASC,MAAb,EAJA;AAKPO,cAAU,IAAIb,GAAGK,KAAH,CAASC,MAAb;AALH,IA1BF;AAiCNQ,oBAAiB,IAAId,GAAGe,MAAH,CAAUT,MAAd,CAAqB;AACrCU,WAAO;AAD8B,IAArB,CAjCX;AAoCNC,iBAAc,IAAIjB,GAAGe,MAAH,CAAUT,MAAd,CAAqB;AAClCU,WAAO;AAD2B,IAArB,CApCR;AAuCNE,YAAS;AACRT,aAAS,IAAIT,GAAGe,MAAH,CAAUT,MAAd,CAAqB;AAC7BU,YAAO;AADsB,KAArB,CADD;AAIRN,UAAM,IAAIV,GAAGe,MAAH,CAAUT,MAAd,CAAqB;AAC1BU,YAAO;AADmB,KAArB,CAJE;AAORL,WAAO,IAAIX,GAAGe,MAAH,CAAUT,MAAd,CAAqB;AAC3BU,YAAO;AADoB,KAArB,CAPC;AAURJ,WAAO,IAAIZ,GAAGe,MAAH,CAAUT,MAAd,CAAqB;AAC3BU,YAAO;AADoB,KAArB,CAVC;AAaRH,cAAU,IAAIb,GAAGe,MAAH,CAAUT,MAAd,CAAqB;AAC9BU,YAAO;AADuB,KAArB;AAbF,IAvCH;AAwDNG,mBAAgB,wBAASC,OAAT,EAAkBC,UAAlB,EAA8B;AAC7C,WAAO,IAAIrB,GAAGsB,KAAH,CAASC,KAAb,CAAmB;AACzBC,WAAM,IAAIxB,GAAGsB,KAAH,CAASG,IAAb,CAAkB;AACvBC,YAAM,2BADiB;AAEvBF,YAAMJ,QAAQO,GAAR,CAAY,MAAZ,CAFiB;AAGvBC,YAAM,IAAI5B,GAAGsB,KAAH,CAASO,IAAb,CAAkB;AACvBC,cAAOV,QAAQO,GAAR,CAAY,OAAZ;AADgB,OAAlB,CAHiB;AAMvBI,cAAQ,IAAI/B,GAAGsB,KAAH,CAASU,MAAb,CAAoB;AAC3BF,cAAO,MADoB;AAE3BG,cAAO;AAFoB,OAApB;AANe,MAAlB;AADmB,KAAnB,CAAP;AAaA,IAtEK;AAuENC,gBAAa,qBAASd,OAAT,EAAkBC,UAAlB,EAA8B;AAC1C,QAAIS,QAAQV,QAAQO,GAAR,CAAY,OAAZ,KAAwB,OAApC;AACA,WAAO,IAAI3B,GAAGsB,KAAH,CAASC,KAAb,CAAmB;AACzBY,YAAO,IAAInC,GAAGsB,KAAH,CAASc,IAAb,CAAkB;AACxBC,WAAKnE,KAAKoE,IAAL,GAAY,0BADO;AAExBR,aAAOA,KAFiB;AAGxBS,aAAOnB,QAAQO,GAAR,CAAY,UAAZ,IAA0B,GAA1B,GAAgC,CAHf;AAIxBa,eAAS;AAJe,MAAlB;AADkB,KAAnB,CAAP;AAQA,IAjFK;AAkFNC,cAAW,mBAASC,IAAT,EAAe;AACzB,QAAIC,OAAO,IAAX;AACA,QAAIC,WAAW;AACdnC,cAAS,OADK;AAEdC,WAAM,MAFQ;AAGdC,YAAO,SAHO;AAIdC,YAAO,QAJO;AAKdC,eAAU;AALI,KAAf;AAOA,WAAO,UAASO,OAAT,EAAkB;AACxB,YAAO,IAAIpB,GAAGsB,KAAH,CAASC,KAAb,CAAmB;AACzBQ,cAAQ,IAAI/B,GAAGsB,KAAH,CAASU,MAAb,CAAoB;AAC3BF,cAAOc,SAASF,IAAT,CADoB;AAE3BT,cAAOb,QAAQO,GAAR,CAAY,IAAZ,KAAqBgB,KAAK7C,gBAA1B,GAA6C,CAA7C,GAAiD;AAF7B,OAApB;AADiB,MAAnB,CAAP;AAMA,KAPD;AAQA,IAnGK;AAoGN+C,eAAY,sBAAW;AACtB,QAAIF,OAAO,IAAX;AACA,QAAIA,KAAK9C,QAAT,EAAmB;AAClB;AACAiD,mBAAcH,KAAK9C,QAAnB;AACA8C,UAAK9C,QAAL,GAAgBX,SAAhB;AACA;AACD,QAAIyD,KAAK/C,WAAL,IAAoB+C,KAAKhD,IAA7B;AACC;AACAgD,UAAK9C,QAAL,GAAgBkD,YAAY,YAAW;AACtCJ,WAAKK,OAAL;AACA,MAFe,EAEb,KAFa,CAAhB;AAGDL,SAAKK,OAAL;AACA,IAjHK;;AAmHNC,iBAAc,sBAASC,IAAT,EAAeC,KAAf,EAAsB;AACnC,QAAI,CAACD,IAAL,EACC;AACD,QAAIP,OAAO,IAAX;AACA;AACA;AACA,QAAIQ,SAASR,KAAK1B,YAAL,CAAkBmC,WAAlB,GAAgCC,MAA7C,EACCV,KAAK1B,YAAL,CAAkBkC,KAAlB;AACDR,SAAKtD,MAAL,GAAcH,SAAd;AACAyD,SAAKrD,WAAL,GAAmBJ,SAAnB;AACAyD,SAAKpD,kBAAL,GAA0B,CAAC,CAAD,EAAI,CAAJ,CAA1B;AACA,QAAI2D,KAAKI,MAAT,EAAiB;AAChBJ,UAAKI,MAAL,CAAY3E,OAAZ,CAAoB,UAAS4E,IAAT,EAAe;AAClC,UAAIC,YAAY,KAAhB;AACA;AACA;;;;;AAKAb,WAAKpD,kBAAL,GAA0BS,GAAGyD,IAAH,CAAQC,SAAR,CAAkB,CAACH,KAAKI,UAAL,GAAkB,GAAnB,EAAwBJ,KAAKK,QAAL,GAAgB,EAAxC,CAAlB,EAA+D,WAA/D,EAA4E,WAA5E,CAA1B;AACAjB,WAAK1B,YAAL,CAAkB4C,UAAlB,CAA6B,IAAI7D,GAAG8D,OAAP,CAAe;AAC3CC,iBAAU,IAAI/D,GAAGgE,IAAH,CAAQC,KAAZ,CAAkBtB,KAAKpD,kBAAvB,CADiC;AAE3CuC,cAAOyB,KAAKzB,KAF+B;AAG3CoC,aAAMX,KAAKW,IAHgC;AAI3CC,WAAIZ,KAAKY,EAJkC;AAK3CC,iBAAUb,KAAKa,QAL4B;AAM3CC,YAAKd,KAAKK,QANiC;AAO3CU,aAAMf,KAAKI,UAPgC;AAQ3CY,iBAAUf;AARiC,OAAf,CAA7B;AAUA,MAnBD;AAoBA;AACD;AACA;AACA,QAAIL,KAAJ,EACCqB,EAAEC,IAAF,CAAO9B,KAAKzB,OAAZ,EAAqB,UAASwD,GAAT,EAAc3D,MAAd,EAAsB;AAC1C,SAAIA,OAAOqC,WAAP,GAAqBC,MAAzB,EACCtC,OAAOoC,KAAP;AACD,KAHD;AAID,QAAIwB,QAAJ,EAAcC,aAAd;AACA,QAAI1B,KAAK2B,QAAT,EAAmB;AAClBlC,UAAKmC,gBAAL,CAAsBC,IAAtB,GAA6B,EAA7B;AACA7B,UAAK2B,QAAL,CAAclG,OAAd,CAAsB,UAASqG,IAAT,EAAe;AACpC9B,WAAKI,MAAL,CAAY3E,OAAZ,CAAoB,UAAS4E,IAAT,EAAe;AAClC,WAAIA,KAAKY,EAAL,KAAYa,KAAKjE,MAArB,EAA6B;AAC5B4D,mBAAW3E,GAAGyD,IAAH,CAAQC,SAAR,CAAkB,CAACH,KAAKI,UAAL,GAAkB,GAAnB,EAAwBJ,KAAKK,QAAL,GAAgB,EAAxC,CAAlB,EAA+D,WAA/D,EAA4E,WAA5E,CAAX;AACAoB,aAAKC,WAAL,GAAmB1B,KAAKW,IAAxB;AACAgB;AACA;AACD,WAAI3B,KAAKY,EAAL,KAAYa,KAAKG,WAArB,EAAkC;AACjCP,wBAAgB5E,GAAGyD,IAAH,CAAQC,SAAR,CAAkB,CAACH,KAAKI,UAAL,GAAkB,GAAnB,EAAwBJ,KAAKK,QAAL,GAAgB,EAAxC,CAAlB,EAA+D,WAA/D,EAA4E,WAA5E,CAAhB;AACAoB,aAAKI,gBAAL,GAAwB7B,KAAKW,IAA7B;AACA;AACA;;AAED,gBAASgB,sBAAT,GAAkC;AACjC,YAAIF,KAAKK,YAAT,EAAuB;AACtB,aAAIvD,QAAQ,EAACpB,MAAM,MAAP,EAAeC,OAAO,SAAtB,EAAiCC,OAAO,QAAxC,EAAkDC,UAAU,KAA5D,GAAmEmE,KAAKM,iBAAxE,CAAZ;AACA3C,cAAKmC,gBAAL,CAAsBC,IAAtB,CAA2BQ,IAA3B,CAAgC;AAC/BpB,cAAIa,KAAKb,EADsB;AAE/BD,gBAAMX,KAAKW,IAFoB;AAG/BN,oBAAUL,KAAKK,QAHgB;AAI/BD,sBAAYJ,KAAKI,UAJc;AAK/BjB,gBAAMsC,KAAKM,iBALoB;AAM/BxD,iBAAOA;AANwB,UAAhC;AAQA;AACD;AACD,OAzBD;AA0BA,UAAI,CAAC6C,QAAD,IAAa,CAACC,aAAlB,EACC;AACD,UAAII,KAAKb,EAAL,IAAWxB,KAAK7C,gBAApB,EAAsC;AACrC,WAAIR,cAAc,EAAlB;AACA,WAAIqF,SAAS,CAAT,MAAgBC,cAAc,CAAd,CAAhB,IAAoCD,SAAS,CAAT,MAAgBC,cAAc,CAAd,CAAxD,EAA0E;AACzEjC,aAAKtD,MAAL,GAAc,CAACsF,SAAS,CAAT,CAAD,EAAcA,SAAS,CAAT,CAAd,CAAd;AACA,QAFD,MAEO;AACN,YAAIA,SAAS,CAAT,IAAcC,cAAc,CAAd,CAAlB,EAAoC;AACnCtF,qBAAYkG,OAAZ,GAAsBZ,cAAc,CAAd,CAAtB;AACAtF,qBAAYmG,OAAZ,GAAsBd,SAAS,CAAT,CAAtB;AACA,SAHD,MAGO;AACNrF,qBAAYkG,OAAZ,GAAsBb,SAAS,CAAT,CAAtB;AACArF,qBAAYmG,OAAZ,GAAsBb,cAAc,CAAd,CAAtB;AACA;AACD,YAAID,SAAS,CAAT,IAAcC,cAAc,CAAd,CAAlB,EAAoC;AACnCtF,qBAAYoG,MAAZ,GAAqBd,cAAc,CAAd,CAArB;AACAtF,qBAAYqG,MAAZ,GAAqBhB,SAAS,CAAT,CAArB;AACA,SAHD,MAGO;AACNrF,qBAAYoG,MAAZ,GAAqBf,SAAS,CAAT,CAArB;AACArF,qBAAYqG,MAAZ,GAAqBf,cAAc,CAAd,CAArB;AACA;AACDjC,aAAKrD,WAAL,GAAmB,CAACA,YAAYmG,OAAb,EAAsBnG,YAAYqG,MAAlC,EAA0CrG,YAAYkG,OAAtD,EAA+DlG,YAAYoG,MAA3E,CAAnB;AACA;AACD;AACD,UAAIV,KAAKK,YAAT,EAAuB;AACtB1C,YAAKzB,OAAL,CAAa8D,KAAKM,iBAAlB,EAAqCzB,UAArC,CAAgD,IAAI7D,GAAG8D,OAAP,CAAe;AAC9DC,kBAAU,IAAI/D,GAAGgE,IAAH,CAAQ4B,UAAZ,CAAuB,CAACjB,QAAD,EAAWC,aAAX,CAAvB,CADoD;AAE9DT,YAAIa,KAAKb,EAFqD;AAG9Dc,qBAAaD,KAAKC,WAH4C;AAI9DG,0BAAkBJ,KAAKI,gBAJuC;AAK9DS,eAAOb,KAAKC,WAAL,GAAmB,IAAnB,GAA0BD,KAAKI,gBALwB;AAM9D1C,cAAMsC,KAAKM;AANmD,QAAf,CAAhD;AAQA,OATD,MASO;AACN3C,YAAKzB,OAAL,CAAaT,OAAb,CAAqBoD,UAArB,CAAgC,IAAI7D,GAAG8D,OAAP,CAAe;AAC9CC,kBAAU,IAAI/D,GAAGgE,IAAH,CAAQ4B,UAAZ,CAAuB,CAACjB,QAAD,EAAWC,aAAX,CAAvB,CADoC;AAE9CT,YAAIa,KAAKb,EAFqC;AAG9Cc,qBAAaD,KAAKC,WAH4B;AAI9CG,0BAAkBJ,KAAKI,gBAJuB;AAK9CS,eAAOb,KAAKC,WAAL,GAAmB,IAAnB,GAA0BD,KAAKI,gBALQ;AAM9C1C,cAAM;AANwC,QAAf,CAAhC;AAQA;AACD,MAtED;AAuEAC,UAAKmC,gBAAL,CAAsBgB,MAAtB,CAA6BnD,IAA7B;AACA;;AAED,QAAI,CAACA,KAAK/C,WAAV,EACC+C,KAAKoD,SAAL,CAAeC,OAAf,CAAuBrD,IAAvB;AACD,IA1OK;AA2ONoD,cAAW;AACVE,WAAO/G,SADG;AAEV8G,aAAS,iBAASE,IAAT,EAAeC,OAAf,EAAwBC,KAAxB,EAA+B;AACvC,SAAIC,MAAMH,KAAK9G,SAAf;AACA,SAAI,KAAK6G,KAAT;AACC;AACAK,mBAAa,KAAKL,KAAlB;AACD;AACA,UAAKA,KAAL,GAAaM,WAAW,YAAW;AAClC,UAAIC,SAASxG,GAAGyG,SAAH,CAAaD,MAAb,CAAoB;AAChCnF,mBAAY6E,KAAKnG,IAAL,CAAU2G,aAAV,KAA4B;AADR,OAApB,CAAb;AAGA,UAAIC,MAAM3G,GAAGyG,SAAH,CAAaE,GAAb,CAAiB;AAC1B5F,eAAQmF,KAAKnG,IAAL,CAAU6G,SAAV;AADkB,OAAjB,CAAV;AAGA,UAAInH,OAAOO,GAAGyG,SAAH,CAAahH,IAAb,CAAkB;AAC5B4B,mBAAY6E,KAAKnG,IAAL,CAAU2G,aAAV;AADgB,OAAlB,CAAX;AAGA;AACAL,UAAIQ,YAAJ,CAAiBF,GAAjB;AACAN,UAAIQ,YAAJ,CAAiBpH,IAAjB;;AAEAyG,WAAK1G,IAAL,GAAY;AACXH,eAAQ6G,KAAKnG,IAAL,CAAU6G,SAAV,EADG;AAEXnH,aAAMyG,KAAKnG,IAAL,CAAU+G,OAAV;AAFK,OAAZ;;AAKA,UAAIX,OAAJ,EAAa;AACZD,YAAKnG,IAAL,CAAUgG,SAAV,CAAoBI,OAApB;AACAD,YAAKnG,IAAL,CAAUgH,OAAV,CAAkBX,SAASF,KAAKnG,IAAL,CAAU+G,OAAV,EAA3B;AACA,OAHD,MAGO,IAAIZ,KAAK7G,MAAT,EAAiB;AACvB6G,YAAKnG,IAAL,CAAUgG,SAAV,CAAoBG,KAAK7G,MAAzB;AACA6G,YAAKnG,IAAL,CAAUgH,OAAV,CAAkB,EAAlB;AACA,OAHM,MAGA,IAAIb,KAAK5G,WAAT,EAAsB;AAC5B4G,YAAKnG,IAAL,CAAUiH,GAAV,CAAcd,KAAK5G,WAAnB,EAAgC4G,KAAK9G,SAAL,CAAe6H,OAAf,EAAhC;AACA,OAFM,MAEA;AACNf,YAAKnG,IAAL,CAAUgG,SAAV,CAAoBG,KAAK3G,kBAAzB;AACA2G,YAAKnG,IAAL,CAAUgH,OAAV,CAAkB,CAAlB;AACA;AACD,MA/BY,EA+BV,GA/BU,CAAb;AAgCA;AAxCS,IA3OL;AAqRNjC,qBAAkB;AACjBC,UAAM,EADW;AAEjBmC,YAAQ,gBAASb,GAAT,EAAc;AACrB,SAAIa,SAAS,EAAb;AACA,UAAKnC,IAAL,CAAUpG,OAAV,CAAkB,UAASwI,OAAT,EAAkB;AACnC,UAAIC,WAAW,KAAf;AACA,UAAIC,aAAarH,GAAGyD,IAAH,CAAQC,SAAR,CAAkB,CAACyD,QAAQxD,UAAT,EAAqBwD,QAAQvD,QAA7B,CAAlB,EAA0D,WAA1D,EAAuE,WAAvE,CAAjB;AACAuD,cAAQG,KAAR,GAAgBjB,IAAIkB,sBAAJ,CAA2BF,UAA3B,CAAhB;AACAH,aAAOvI,OAAP,CAAe,UAAS6I,KAAT,EAAgB;AAC9B,WAAIJ,QAAJ,EAAc;AACd,WAAID,QAAQG,KAAR,CAAc,CAAd,KAAoBE,MAAMF,KAAN,CAAY,CAAZ,IAAe,GAAnC,IAA0CH,QAAQG,KAAR,CAAc,CAAd,IAAmBE,MAAMF,KAAN,CAAY,CAAZ,IAAe,GAA5E,IAAmFH,QAAQG,KAAR,CAAc,CAAd,KAAoBE,MAAMF,KAAN,CAAY,CAAZ,IAAe,GAAtH,IAA6HH,QAAQG,KAAR,CAAc,CAAd,IAAmBE,MAAMF,KAAN,CAAY,CAAZ,IAAe,GAAnK,EAAwK;AACvKE,cAAMC,QAAN,CAAeN,QAAQzE,IAAvB,EAA6B6C,IAA7B,CAAkC4B,OAAlC;AACAC,mBAAW,IAAX;AACA;AACD,OAND;AAOA,UAAI,CAACA,QAAL,EAAe;AACd,WAAIK,WAAW;AACd5G,kBAAU,EADI;AAEdD,eAAO,EAFO;AAGdD,eAAO,EAHO;AAIdD,cAAM;AAJQ,QAAf;AAMA+G,gBAASN,QAAQzE,IAAjB,EAAuB6C,IAAvB,CAA4B4B,OAA5B;AACA,WAAIK,QAAQ;AACX5D,kBAAUuD,QAAQvD,QADP;AAEXD,oBAAYwD,QAAQxD,UAFT;AAGX0D,oBAAYA,UAHD;AAIXC,eAAOH,QAAQG,KAJJ;AAKXG,kBAAUA;AALC,QAAZ;AAOAP,cAAO3B,IAAP,CAAYiC,KAAZ;AACA;AACD,MA5BD;AA6BA,YAAON,MAAP;AACA,KAlCgB;AAmCjBpB,YAAQ,gBAASI,IAAT,EAAe;AACtB,SAAIG,MAAMH,KAAK9G,SAAf;AACA,SAAI8G,KAAKpF,eAAL,CAAqBsC,WAArB,GAAmCC,MAAvC,EACC6C,KAAKpF,eAAL,CAAqBqC,KAArB;AACD,UAAK+D,MAAL,CAAYb,GAAZ,EAAiB1H,OAAjB,CAAyB,UAAS6I,KAAT,EAAgB;AACxC,UAAIE,QAAQ,CAAZ;AACA,OAAC,UAAD,EAAa,OAAb,EAAsB,OAAtB,EAA+B,MAA/B,EAAuC/I,OAAvC,CAA+C,UAAS+D,IAAT,EAAe;AAC7D8E,aAAMC,QAAN,CAAe/E,IAAf,EAAqB/D,OAArB,CAA6B,UAASwI,OAAT,EAAkB;AAC9CO,iBAAS,CAAT;AACA,YAAIA,QAAQ,EAAZ,EAAgB,OAF8B,CAEtB;AACxB,YAAI1D,OAAO,IAAIhE,GAAGgE,IAAH,CAAQC,KAAZ,CACVoC,IAAIsB,sBAAJ,CAA2B,CAACH,MAAMF,KAAN,CAAY,CAAZ,CAAD,EAAiBE,MAAMF,KAAN,CAAY,CAAZ,IAAgB,CAAC,EAAD,GAAII,KAArC,CAA3B,CADU,CAAX;AAGA,YAAItG,UAAU,IAAIpB,GAAG8D,OAAP,CAAe;AAC5BC,mBAAUC,IADkB;AAE5BlC,gBAAOqF,QAAQrF,KAFa;AAG5BoC,eAAMiD,QAAQjD,IAHc;AAI5BC,aAAIgD,QAAQhD;AAJgB,SAAf,CAAd;AAMA/C,gBAAQwG,QAAR,CAAiB1B,KAAK/E,cAAL,CAAoBC,OAApB,CAAjB;AACA8E,aAAKpF,eAAL,CAAqB+C,UAArB,CAAgCzC,OAAhC;AACA,QAdD;AAeA,OAhBD;AAiBA,MAnBD;AAoBA;AA3DgB,IArRZ;AAkVNyG,eAAY,sBAAW;AACtB,QAAIlF,OAAO,IAAX;AAAA,QACC0D,MAAM1D,KAAKvD,SADZ;AAEA,QAAIA,YAAY0I,SAASC,cAAT,CAAwB,OAAxB,CAAhB;AAAA,QACCC,kBAAkBF,SAASC,cAAT,CAAwB,eAAxB,CADnB;AAAA,QAECE,SAASH,SAASC,cAAT,CAAwB,cAAxB,CAFV;;AAIC3I,cAAUkC,KAAV,CAAgB4G,UAAhB,GAA6B,SAA7B;;AAEDD,WAAOE,OAAP,GAAiBC,YAAjB;AACA,aAASA,YAAT,GAAwB;AACvBC,aAAQC,WAAR,CAAoBpJ,SAApB;AACA+I,YAAOM,IAAP;AACA5F,UAAKoD,SAAL,CAAeC,OAAf,CAAuBrD,IAAvB,EAA6BA,KAAKnD,IAAL,CAAUH,MAAvC,EAA+CsD,KAAKnD,IAAL,CAAUC,IAAzD;AACA,YAAO,KAAP;AACA;;AAED,QAAI4I,UAAU,IAAIrI,GAAGwI,OAAP,CAAe;AAC5BC,cAASrJ,SADmB;AAE5BsJ,cAAS,IAFmB;AAG5BC,aAAQ,CAAC,CAAD,EAAI,CAAC,EAAL;AAHoB,KAAf,CAAd;AAKAtC,QAAIuC,UAAJ,CAAeP,OAAf;;AAEAhC,QAAIwC,EAAJ,CAAO,OAAP,EAAgB,UAASC,KAAT,EAAgB;AAC/B,SAAIlG,WAAW;AACdnC,eAAS,OADK;AAEdC,YAAM,MAFQ;AAGdC,aAAO,SAHO;AAIdC,aAAO,QAJO;AAKdC,gBAAU;AALI,MAAf;;AAQA,SAAIkI,iBAAiB,EAArB;AAAA,SACCC,kBAAkB,EADnB;;AAGA3C,SAAI4C,qBAAJ,CAA0BH,MAAMxB,KAAhC,EAAuC,UAASlG,OAAT,EAAkBf,KAAlB,EAAyB;AAC/D,UAAIA,UAAUsC,KAAKpC,WAAnB,EAAgC;AAC/B,WAAI,CAACwI,eAAe3H,QAAQO,GAAR,CAAY,MAAZ,CAAf,CAAL,EACCoH,eAAe3H,QAAQO,GAAR,CAAY,MAAZ,CAAf,IAAsC,EAACwC,IAAI/C,QAAQO,GAAR,CAAY,IAAZ,CAAL,EAAwBuH,OAAO9H,QAAQ+H,WAAR,GAAsBC,cAAtB,EAA/B,EAAtC;AACD,OAHD,MAGO,IAAI/I,UAAUsC,KAAKvC,cAAnB,EAAmC;AACzC;AACA;AACA,OAHM,MAGA;AACN,WAAI,CAAC4I,gBAAgB5H,QAAQO,GAAR,CAAY,OAAZ,CAAhB,CAAL,EACCqH,gBAAgB5H,QAAQO,GAAR,CAAY,OAAZ,CAAhB,IAAwC,EAACwC,IAAI/C,QAAQO,GAAR,CAAY,IAAZ,CAAL,EAAwBG,OAAOc,SAASxB,QAAQO,GAAR,CAAY,MAAZ,CAAT,CAA/B,EAAxC;AACD;AACD,MAXD;;AAaA,SAAI0H,UAAU,EAAd;AACA,SAAG5K,OAAOC,IAAP,CAAYqK,cAAZ,EAA4B1F,MAA/B,EAAuC;;AAEtC;AACA5E,aAAOC,IAAP,CAAYiE,KAAKzB,OAAjB,EAA0BvC,OAA1B,CAAkC,UAAS+D,IAAT,EAAe;AAChD,WAAI4G,WAAW3G,KAAKzB,OAAL,CAAawB,IAAb,EAAmBU,WAAnB,EAAf;AACAkG,gBAAS3K,OAAT,CAAiB,UAASyC,OAAT,EAAkB;AAClC3C,eAAOC,IAAP,CAAYqK,cAAZ,EAA4BpK,OAA5B,CAAoC,UAAS2E,MAAT,EAAiB;AACpD,aAAIlC,QAAQO,GAAR,CAAY,aAAZ,KAA8B2B,MAA9B,IAAwClC,QAAQO,GAAR,CAAY,kBAAZ,KAAmC2B,MAA/E;AACC;AACA0F,0BAAgB5H,QAAQO,GAAR,CAAY,OAAZ,CAAhB,IAAwC,EAACwC,IAAI/C,QAAQO,GAAR,CAAY,IAAZ,CAAL,EAAwBG,OAAOc,SAASxB,QAAQO,GAAR,CAAY,MAAZ,CAAT,CAA/B,EAAxC;AACD,SAJD;AAKA,QAND;AAOA,OATD;;AAWA0H,iBAAW,uCAAX;AACA5K,aAAOC,IAAP,CAAYqK,cAAZ,EAA4BpK,OAA5B,CAAoC,UAASuF,IAAT,EAAe;AAClDmF,kBAAW,kBAAkBN,eAAe7E,IAAf,EAAqBC,EAAvC,GAA4C,gBAA5C,GAA+D4E,eAAe7E,IAAf,EAAqBgF,KAApF,GAA4F,IAA5F,GAAmGhF,IAAnG,GAA0G,OAArH;AACA,OAFD;AAGAmF,iBAAW,OAAX;AACA;AACD,SAAG5K,OAAOC,IAAP,CAAYsK,eAAZ,EAA6B3F,MAAhC,EAAwC;AACvCgG,iBAAW,yCAAX;AACA5K,aAAOC,IAAP,CAAYsK,eAAZ,EAA6BrK,OAA7B,CAAqC,UAASuF,IAAT,EAAe;AACnDmF,kBAAW,uBAAuBL,gBAAgB9E,IAAhB,EAAsBpC,KAA7C,GAAqD,aAArD,GAAqEkH,gBAAgB9E,IAAhB,EAAsBC,EAA3F,GAAgG,IAAhG,GAAuGD,IAAvG,GAA8G,OAAzH;AACA,OAFD;AAGAmF,iBAAW,OAAX;AACA;;AAED,SAAGA,OAAH,EAAY;AACXrB,sBAAgBuB,SAAhB,GAA4BF,OAA5B;AACAhB,cAAQC,WAAR,CAAoBQ,MAAMzB,UAA1B;AACA1E,WAAKoD,SAAL,CAAeC,OAAf,CAAuBrD,IAAvB,EAA6BmG,MAAMzB,UAAnC;AACA,MAJD,MAIO;AACNe;AACA;AACD,KA7DD;;AA+DA,aAASoB,SAAT,CAAmBC,GAAnB,EAAwB;AAAA;;AACvB,SAAIC,OAAJ;AACA,SAAIC,SAASnF,EAAE,IAAF,CAAb;AACA,SAAI0E,QAAQS,OAAOzG,IAAP,CAAY,OAAZ,EAAqB0G,KAArB,CAA2B,GAA3B,CAAZ;AACAV,aAAQ,CAACW,OAAOX,MAAM,CAAN,CAAP,CAAD,EAAmBW,OAAOX,MAAM,CAAN,CAAP,CAAnB,CAAR;;AAEA;;;;;;;;;;;;;;;;;;AAmBA1E,OAAEsF,IAAF,CAAO;AACNC,WAAK7L,KAAK8L,IAAL,GAAY,SAAZ,GAAwBL,OAAOzG,IAAP,CAAY,IAAZ,CAAxB,GAA4C,SAA5C,GAAwD/E,OADvD;AAEN8L,cAAQ;AAFF,MAAP,EAICC,IAJD,CAIM,kBAAU;AACf,UAAIb,UAAU;;sFAAA,GAEqEc,OAAO7G,MAAP,CAAc8G,QAFnF,GAE8F;uFAF9F,GAGsED,OAAO7G,MAAP,CAAc+G,KAHpF,GAG4F;iGAH5F,GAIgFF,OAAO7G,MAAP,CAAcgH,KAJ9F,GAIsG;oFAJtG,GAKmEH,OAAO7G,MAAP,CAAciH,IALjF,GAKwF;qFALxF,GAMoEZ,OAAOnI,IAAP,EANpE,GAMoF;8FANpF,GAO6E2I,OAAO7G,MAAP,CAAckH,YAP3F,GAO0G;iGAP1G,GAQgFL,OAAO7G,MAAP,CAAcmH,eAR9F,GAQgH;oGARhH,GASmFN,OAAO7G,MAAP,CAAcoH,gBATjG,GASoH;mGATpH,GAUkFP,OAAO7G,MAAP,CAAcqH,eAVhG,GAUkH;uCAVhI;;AAaA3C,sBAAgBuB,SAAhB,GAA4BF,OAA5B;AACAhB,cAAQC,WAAR,CAAoBY,KAApB;AACAvG,WAAKoD,SAAL,CAAeC,OAAf,CAAuBrD,IAAvB,EAA6BuG,KAA7B,EAAoC,CAApC;AACA,MArBD,EAsBC0B,IAtBD,CAsBM,aAAK;AACV,UAAIC,EAAEC,MAAF,KAAa,GAAjB,EAAsB;AACrB,aAAK/L,MAAL,CAAYgM,IAAZ,CAAiB,aAAjB;AACA;AACD,YAAKhM,MAAL,CAAYgM,IAAZ,CAAiB,aAAjB;AACA,MA3BD;AA4BA;AACDvG,MAAE,gBAAF,EAAoBqE,EAApB,CAAuB,OAAvB,EAAgC,aAAhC,EAA+CW,SAA/C;;AAEA,aAASwB,UAAT,GAAsB;AACrBC,iBAAYzG,EAAE,IAAF,EAAQtB,IAAR,CAAa,IAAb,CAAZ;AACAgI,eAAUC,IAAV,CAAe,0BAA0BF,SAAzC;AACA;AACDzG,MAAE,gBAAF,EAAoBqE,EAApB,CAAuB,OAAvB,EAAgC,cAAhC,EAAgDmC,UAAhD;AACA,IAteK;AAueNI,aAAU,oBAAW;AACpB,QAAI/E,MAAM,KAAKjH,SAAf;AACA,QAAIiM,aAAa,IAAIrL,GAAGsL,OAAH,CAAWC,UAAf,EAAjB;AACAlF,QAAImF,UAAJ,CAAeH,UAAf;AACA,IA3eK;AA4eNI,cAAW,qBAAW;AACrB,QAAI9I,OAAO,IAAX;AACA,QAAI0D,MAAM,KAAKjH,SAAf;AACA,QAAIsM,gBAAgB/I,KAAK5C,IAAL,CAAU+G,OAAV,EAApB;AACAT,QAAIwC,EAAJ,CAAO,SAAP,EAAkB,UAASC,KAAT,EAAgB;AACjC,SAAI4C,iBAAiB/I,KAAK5C,IAAL,CAAU+G,OAAV,EAArB,EAA0C;AACzC4E,sBAAgB/I,KAAK5C,IAAL,CAAU+G,OAAV,EAAhB;AACAnE,WAAKmC,gBAAL,CAAsBgB,MAAtB,CAA6BnD,IAA7B;AACA;AACD,KALD;AAMA,IAtfK;AAufNgJ,eAAY,sBAAW;AACtB,QAAIhJ,OAAO,IAAX;AACA,QAAI0D,MAAM,KAAKjH,SAAf;AACAiH,QAAIwC,EAAJ,CAAO,aAAP,EAAsB,UAASC,KAAT,EAAgB;AACrC,SAAIA,MAAM8C,QAAV,EAAoB;;AAEpB;AACA,SAAIC,WAAWxF,IAAI4C,qBAAJ,CAA0BH,MAAMxB,KAAhC,EAAuC,UAASlG,OAAT,EAAkBf,KAAlB,EAAyB;AAC9E,UAAIA,UAAUsC,KAAKvC,cAAnB,EACC,OAAO,IAAP;AACD,MAHc,CAAf;AAIAiG,SAAIyF,SAAJ,GAAgBxK,KAAhB,CAAsByK,MAAtB,GAA+BF,WAAW,SAAX,GAAuB,EAAtD,CAAyD;;AAEzD;AACA;AACA;AACA;AACA,KAdD;AAeA,IAzgBK;AA0gBN7I,YAAS,iBAASgJ,MAAT,EAAiB;AAAA;;AACzB,QAAIrJ,OAAO,IAAX;AACAqJ,aAASA,SAASA,MAAT,GAAkB,EAA3B;AACA,QAAIC,OAAOD,OAAOC,IAAP,GAAcD,OAAOC,IAArB,GAA4B,CAAvC;AACA,QAAIC,aAAaF,OAAOG,IAAP,KAAgB,IAAhB,GAAuB,KAAvB,GAA+B,IAAhD;;AAEA;;;;;;;;;AASE;;;;;;;;;;;;;;;;;;;;AAoBF;;;;;AAMA,QAAI7N,IAAI,KAAKW,MAAb;;AAGA,QAAIiE,OAAO,EAAX;AACA,QAAIkJ,IAAI9N,EAAE+N,OAAV;AACA,QAAI/N,EAAE4I,MAAN,EAAchE,KAAKoJ,SAAL,GAAiBC,KAAKC,SAAL,CAAgBlO,EAAE4I,MAAlB,CAAjB;AACd,QAAIkF,CAAJ,EAAOlJ,KAAKuJ,UAAL,GAAkBF,KAAKC,SAAL,CAAgB/N,OAAOC,IAAP,CAAY0N,CAAZ,EAAe/F,GAAf,CAAmB;AAAA,YAAK+F,EAAEvN,CAAF,EAAKsF,EAAV;AAAA,KAAnB,CAAhB,CAAlB;AACP,QAAIvF,SAAS,SAAb;AACAA,cAAUN,EAAEoO,QAAF,GAAa,gBAAb,GAAgC,EAA1C;AACA9N,cAAUN,EAAEqB,IAAF,GAAa,YAAb,GAAgC,EAA1C;AACA,SAAKZ,MAAL,CAAYgM,IAAZ,CAAiB,YAAjB;AACAvG,MAAEsF,IAAF,CAAO;AACNC,UAAK7L,KAAK8L,IAAL,GAAY,iBAAZ,GAAgC7L,OAAhC,GAA0CS,MADzC,EACiD;AACvDqL,aAAQ,MAFF;AAGN0C,kBAAa,KAHP;AAINC,kBAAa,KAJP;AAKN1J,WAAM7E,cAAc6E,IAAd;AALA,KAAP,EAOCgH,IAPD,CAOM,gBAAQ;AACb,YAAKnL,MAAL,CAAYgM,IAAZ,CAAiB,WAAjB;AACA,SAAIkB,OAAO/I,KAAK2J,WAAhB,EAA6B;AAC5B;AACAD,kBAAY1J,IAAZ,EAAkBgJ,UAAlB,EAA8BvJ,IAA9B;AACAA,WAAKK,OAAL,CAAa;AACZiJ,aAAMA,QAAQ,CADF;AAEZE,aAAM;AAFM,OAAb;AAIA;AACA;AACDxJ,UAAKM,YAAL,CAAkBC,IAAlB,EAAwBgJ,UAAxB;AACA,KAnBD,EAoBCtB,IApBD,CAoBM,aAAK;AACV,SAAIC,EAAEC,MAAF,KAAa,GAAjB,EAAsB;AACrB,aAAK/L,MAAL,CAAYgM,IAAZ,CAAiB,aAAjB;AACA;AACD,YAAKhM,MAAL,CAAYgM,IAAZ,CAAiB,WAAjB;AACA,KAzBD,EA0BC+B,MA1BD,CA0BS;AAAA,YAAM,OAAK/N,MAAL,CAAYgM,IAAZ,CAAiB,aAAjB,CAAN;AAAA,KA1BT;AA4BA,IA1lBK;AA2lBNgC,YAAS,mBAAW;AACnB,QAAIpK,OAAO,IAAX;;AAEA,QAAInC,SAAS,CACZ,IAAIR,GAAGK,KAAH,CAAS2M,IAAb,CAAkB;AACjBjM,aAAQ,IAAIf,GAAGe,MAAH,CAAUkM,GAAd,CAAkB;AACzBjM,aAAO;AADkB,MAAlB;AADS,KAAlB,CADY,EAMZ2B,KAAKvC,cANO,EAOZuC,KAAKpC,WAPO,CAAb;;AAUAiE,MAAEC,IAAF,CAAO9B,KAAKnC,MAAZ,EAAoB,UAASkE,GAAT,EAAcrE,KAAd,EAAqB;AACxCA,WAAM6M,SAAN,CAAgBvK,KAAKzB,OAAL,CAAawD,GAAb,CAAhB;AACArE,WAAMuH,QAAN,CAAejF,KAAKF,SAAL,CAAeiC,GAAf,CAAf;AACAlE,YAAO+E,IAAP,CAAYlF,KAAZ;AACA,KAJD;;AAMAsC,SAAKvD,SAAL,GAAiB,IAAIY,GAAGmN,GAAP,CAAW;AAC3B3M,aAAQA,MADmB;AAE3BrB,aAAQwD,KAAKxD,MAFc;AAG3BiO,eAAUpN,GAAGsL,OAAH,CAAW+B,QAAX,CAAoB;AAC7BC,0BAAqB;AACpBC,oBAAa;AADO;AADQ,MAApB,CAHiB;AAQ3BxN,WAAM4C,KAAK5C;AARgB,KAAX,CAAjB;AAUA4C,SAAKpC,WAAL,CAAiB2M,SAAjB,CAA2BvK,KAAK1B,YAAhC;AACA0B,SAAKpC,WAAL,CAAiBqH,QAAjB,CAA0BjF,KAAKT,WAA/B;AACAS,SAAKpC,WAAL,CAAiBiN,SAAjB,CAA2B,EAA3B;;AAEA7K,SAAKvC,cAAL,CAAoB8M,SAApB,CAA8BvK,KAAK7B,eAAnC;AACA6B,SAAKvC,cAAL,CAAoBoN,SAApB,CAA8B,EAA9B;;AAEA;AACA7K,SAAKnC,MAAL,CAAYC,OAAZ,CAAoB+M,SAApB,CAA8B,CAA9B;AACA7K,SAAKnC,MAAL,CAAYE,IAAZ,CAAiB8M,SAAjB,CAA2B,CAA3B;AACA7K,SAAKnC,MAAL,CAAYG,KAAZ,CAAkB6M,SAAlB,CAA4B,CAA5B;AACA7K,SAAKnC,MAAL,CAAYI,KAAZ,CAAkB4M,SAAlB,CAA4B,CAA5B;AACA7K,SAAKnC,MAAL,CAAYK,QAAZ,CAAqB2M,SAArB,CAA+B,CAA/B;AACA,IAroBK;AAsoBNC,SAAM,cAASC,IAAT,EAAe;AACpB,QAAI/K,OAAO,IAAX;;AAEAA,SAAKoK,OAAL;AACA,QAAIW,IAAJ,EAAU/K,KAAKK,OAAL;AACVL,SAAKgJ,UAAL;AACAhJ,SAAK8I,SAAL;AACA9I,SAAKkF,UAAL;AACA;AACA;AA/oBK,GAAP;AAipBA;;AAEDzJ,MAAKU,MAAL,GAAcA,MAAd;AACA,QAAOV,IAAP;AACA,CAjqBD","file":"mapMaker.js","sourcesContent":["define([\"core/config\", \"core/token\"], (conf, token) => {\r\n\tconst inst = {};\r\n\t\r\n\tfunction buildFormdata(o) {\r\n\t\tlet res = new FormData();\r\n\t\tObject.keys(o).forEach(k => {\r\n\t\t\tres.append(k, o[k]);\r\n\t\t});\r\n\t\treturn res;\r\n\t}\r\n\t\r\n\tfunction newMap() {\r\n\t\treturn {\r\n\t\t\tevents: newPubSub(),\r\n\t\t\ttoSend: undefined,\r\n\t\t\t\r\n\t\t\ttarget: undefined,\r\n\t\t\tcontainer: undefined,\r\n\t\t\tcenter: undefined,\r\n\t\t\tcoordinates: undefined,\r\n\t\t\tlastDevicePosition: [0, 0],\r\n\t\t\tlast: {\r\n\t\t\t\tcenter: [0, 0],\r\n\t\t\t\tzoom: 5\r\n\t\t\t},\r\n\t\t\tisViolated: false,\r\n\t\t\tlive: true,\r\n\t\t\tautoRefresh: false,\r\n\t\t\tinterval: undefined,\r\n\t\t\tdefaultCircuitID: undefined, // $routeParams.circuitId,\r\n\t\t\tview: new ol.View({\r\n\t\t\t\tzoom: 5,\r\n\t\t\t\tmaxZoom: 21,\r\n\t\t\t\tminZoom: 2.5,\r\n\t\t\t\tcenter: [0, 0]\r\n\t\t\t}),\r\n\t\t\tviolationLayer: new ol.layer.Vector(),\r\n\t\t\tdeviceLayer: new ol.layer.Vector(),\r\n\t\t\tlayers: {\r\n\t\t\t\tcircuit: new ol.layer.Vector(),\r\n\t\t\t\tinfo: new ol.layer.Vector(),\r\n\t\t\t\tminor: new ol.layer.Vector(),\r\n\t\t\t\tmajor: new ol.layer.Vector(),\r\n\t\t\t\tcritical: new ol.layer.Vector()\r\n\t\t\t},\r\n\t\t\tviolationSource: new ol.source.Vector({\r\n\t\t\t\twrapX: false\r\n\t\t\t}),\r\n\t\t\tdeviceSource: new ol.source.Vector({\r\n\t\t\t\twrapX: false\r\n\t\t\t}),\r\n\t\t\tsources: {\r\n\t\t\t\tcircuit: new ol.source.Vector({\r\n\t\t\t\t\twrapX: false\r\n\t\t\t\t}),\r\n\t\t\t\tinfo: new ol.source.Vector({\r\n\t\t\t\t\twrapX: false\r\n\t\t\t\t}),\r\n\t\t\t\tminor: new ol.source.Vector({\r\n\t\t\t\t\twrapX: false\r\n\t\t\t\t}),\r\n\t\t\t\tmajor: new ol.source.Vector({\r\n\t\t\t\t\twrapX: false\r\n\t\t\t\t}),\r\n\t\t\t\tcritical: new ol.source.Vector({\r\n\t\t\t\t\twrapX: false\r\n\t\t\t\t}),\r\n\t\t\t},\r\n\t\t\tviolationStyle: function(feature, resolution) {\r\n\t\t\t\treturn new ol.style.Style({\r\n\t\t\t\t\ttext: new ol.style.Text({\r\n\t\t\t\t\t\tfont: '10px helvetica,sans-serif',\r\n\t\t\t\t\t\ttext: feature.get('name'),\r\n\t\t\t\t\t\tfill: new ol.style.Fill({\r\n\t\t\t\t\t\t\tcolor: feature.get(\"color\")\r\n\t\t\t\t\t\t}),\r\n\t\t\t\t\t\tstroke: new ol.style.Stroke({\r\n\t\t\t\t\t\t\tcolor: '#fff',\r\n\t\t\t\t\t\t\twidth: 8\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t})\r\n\t\t\t\t});\r\n\t\t\t},\r\n\t\t\tdeviceStyle: function(feature, resolution) {\r\n\t\t\t\tvar color = feature.get(\"color\") || \"green\";\r\n\t\t\t\treturn new ol.style.Style({\r\n\t\t\t\t\timage: new ol.style.Icon({\r\n\t\t\t\t\t\tsrc: conf.ROOT + \"images/location-icon.svg\",\r\n\t\t\t\t\t\tcolor: color,\r\n\t\t\t\t\t\tscale: feature.get(\"selected\") ? 1.5 : 1,\r\n\t\t\t\t\t\topacity: 1,\r\n\t\t\t\t\t})\r\n\t\t\t\t});\r\n\t\t\t},\r\n\t\t\tlineStyle: function(type) {\r\n\t\t\t\tvar self = this;\r\n\t\t\t\tvar colorMap = {\r\n\t\t\t\t\tcircuit: \"green\",\r\n\t\t\t\t\tinfo: \"blue\",\r\n\t\t\t\t\tminor: \"#f7bb38\",\r\n\t\t\t\t\tmajor: \"orange\",\r\n\t\t\t\t\tcritical: \"red\"\r\n\t\t\t\t};\r\n\t\t\t\treturn function(feature) {\r\n\t\t\t\t\treturn new ol.style.Style({\r\n\t\t\t\t\t\tstroke: new ol.style.Stroke({\r\n\t\t\t\t\t\t\tcolor: colorMap[type],\r\n\t\t\t\t\t\t\twidth: feature.get(\"id\") == self.defaultCircuitID ? 5 : 2\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t});\r\n\t\t\t\t};\r\n\t\t\t},\r\n\t\t\trefreshMap: function() {\r\n\t\t\t\tvar self = this;\r\n\t\t\t\tif (self.interval) {\r\n\t\t\t\t\t//$interval.cancel(self.interval);\r\n\t\t\t\t\tclearInterval(self.interval);\r\n\t\t\t\t\tself.interval = undefined;\r\n\t\t\t\t}\r\n\t\t\t\tif (self.autoRefresh && self.live)\r\n\t\t\t\t\t//self.interval = $interval(function() {\r\n\t\t\t\t\tself.interval = setInterval(function() {\r\n\t\t\t\t\t\tself.getData();\r\n\t\t\t\t\t}, 15000);\r\n\t\t\t\tself.getData();\r\n\t\t\t},\r\n\t\t   \r\n\t\t\taddDataToMap: function(data, clear) {\r\n\t\t\t\tif (!data)\r\n\t\t\t\t\treturn;\r\n\t\t\t\tvar self = this;\r\n\t\t\t\t// Add Devices\r\n\t\t\t\t// TODO: can make function for this part\r\n\t\t\t\tif (clear && self.deviceSource.getFeatures().length)\r\n\t\t\t\t\tself.deviceSource.clear();\r\n\t\t\t\tself.center = undefined;\r\n\t\t\t\tself.coordinates = undefined;\r\n\t\t\t\tself.lastDevicePosition = [0, 0];\r\n\t\t\t\tif (data.device) {\r\n\t\t\t\t\tdata.device.forEach(function(node) {\r\n\t\t\t\t\t\tvar isSeleced = false;\r\n\t\t\t\t\t\t// if ([_SELECTED_DEVICES_IDS_].indexOf(node.id.toString()) !== -1) {\r\n\t\t\t\t\t\t/* if ($($scope.console.deviceSelectElement).val().split(\",\").indexOf(node.id.toString()) !== -1) {\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tself.center = ol.proj.transform([node.longtitude % 180, node.latitude % 90], 'EPSG:4326', 'EPSG:3857');\r\n\t\t\t\t\t\t\tisSeleced = true;\r\n\t\t\t\t\t\t} */\r\n\t\t\t\t\t\tself.lastDevicePosition = ol.proj.transform([node.longtitude % 180, node.latitude % 90], 'EPSG:4326', 'EPSG:3857');\r\n\t\t\t\t\t\tself.deviceSource.addFeature(new ol.Feature({\r\n\t\t\t\t\t\t\tgeometry: new ol.geom.Point(self.lastDevicePosition),\r\n\t\t\t\t\t\t\tcolor: node.color,\r\n\t\t\t\t\t\t\tname: node.name,\r\n\t\t\t\t\t\t\tid: node.id,\r\n\t\t\t\t\t\t\tlocation: node.location,\r\n\t\t\t\t\t\t\tlat: node.latitude,\r\n\t\t\t\t\t\t\tlong: node.longtitude,\r\n\t\t\t\t\t\t\tselected: isSeleced\r\n\t\t\t\t\t\t}));\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t\t// Add Circuits\r\n\t\t\t\t// TODO: can make function for this part\r\n\t\t\t\tif (clear)\r\n\t\t\t\t\t$.each(self.sources, function(key, source) {\r\n\t\t\t\t\t\tif (source.getFeatures().length)\r\n\t\t\t\t\t\t\tsource.clear();\r\n\t\t\t\t\t});\r\n\t\t\t\tvar sourceXY, destinationXY;\r\n\t\t\t\tif (data.circuits) {\r\n\t\t\t\t\tself.violatedServices.list = [];\r\n\t\t\t\t\tdata.circuits.forEach(function(link) {\r\n\t\t\t\t\t\tdata.device.forEach(function(node) {\r\n\t\t\t\t\t\t\tif (node.id === link.source) {\r\n\t\t\t\t\t\t\t\tsourceXY = ol.proj.transform([node.longtitude % 180, node.latitude % 90], 'EPSG:4326', 'EPSG:3857');\r\n\t\t\t\t\t\t\t\tlink.source_name = node.name;\r\n\t\t\t\t\t\t\t\tfilterViolatedServices();\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tif (node.id === link.destination) {\r\n\t\t\t\t\t\t\t\tdestinationXY = ol.proj.transform([node.longtitude % 180, node.latitude % 90], 'EPSG:4326', 'EPSG:3857');\r\n\t\t\t\t\t\t\t\tlink.destination_name = node.name;\r\n\t\t\t\t\t\t\t\t// filterViolatedServices();\r\n\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\tfunction filterViolatedServices() {\r\n\t\t\t\t\t\t\t\tif (link.sla_violated) {\r\n\t\t\t\t\t\t\t\t\tvar color = {info: \"blue\", minor: \"#f7bb38\", major: \"orange\", critical: \"red\"}[link.sla_violated_type];\r\n\t\t\t\t\t\t\t\t\tself.violatedServices.list.push({\r\n\t\t\t\t\t\t\t\t\t\tid: link.id,\r\n\t\t\t\t\t\t\t\t\t\tname: node.name,\r\n\t\t\t\t\t\t\t\t\t\tlatitude: node.latitude,\r\n\t\t\t\t\t\t\t\t\t\tlongtitude: node.longtitude,\r\n\t\t\t\t\t\t\t\t\t\ttype: link.sla_violated_type,\r\n\t\t\t\t\t\t\t\t\t\tcolor: color\r\n\t\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tif (!sourceXY || !destinationXY)\r\n\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\tif (link.id == self.defaultCircuitID) {\r\n\t\t\t\t\t\t\tvar coordinates = {};\r\n\t\t\t\t\t\t\tif (sourceXY[0] === destinationXY[0] && sourceXY[1] === destinationXY[1]) {\r\n\t\t\t\t\t\t\t\tself.center = [sourceXY[0], sourceXY[1]];\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tif (sourceXY[0] < destinationXY[0]) {\r\n\t\t\t\t\t\t\t\t\tcoordinates.maxLong = destinationXY[0];\r\n\t\t\t\t\t\t\t\t\tcoordinates.minLong = sourceXY[0];\r\n\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\tcoordinates.maxLong = sourceXY[0];\r\n\t\t\t\t\t\t\t\t\tcoordinates.minLong = destinationXY[0];\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tif (sourceXY[1] < destinationXY[1]) {\r\n\t\t\t\t\t\t\t\t\tcoordinates.maxLat = destinationXY[1];\r\n\t\t\t\t\t\t\t\t\tcoordinates.minLat = sourceXY[1];\r\n\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\tcoordinates.maxLat = sourceXY[1];\r\n\t\t\t\t\t\t\t\t\tcoordinates.minLat = destinationXY[1];\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tself.coordinates = [coordinates.minLong, coordinates.minLat, coordinates.maxLong, coordinates.maxLat];\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (link.sla_violated) {\r\n\t\t\t\t\t\t\tself.sources[link.sla_violated_type].addFeature(new ol.Feature({\r\n\t\t\t\t\t\t\t\tgeometry: new ol.geom.LineString([sourceXY, destinationXY]),\r\n\t\t\t\t\t\t\t\tid: link.id,\r\n\t\t\t\t\t\t\t\tsource_name: link.source_name,\r\n\t\t\t\t\t\t\t\tdestination_name: link.destination_name,\r\n\t\t\t\t\t\t\t\talias: link.source_name + \"::\" + link.destination_name,\r\n\t\t\t\t\t\t\t\ttype: link.sla_violated_type\r\n\t\t\t\t\t\t\t}));\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tself.sources.circuit.addFeature(new ol.Feature({\r\n\t\t\t\t\t\t\t\tgeometry: new ol.geom.LineString([sourceXY, destinationXY]),\r\n\t\t\t\t\t\t\t\tid: link.id,\r\n\t\t\t\t\t\t\t\tsource_name: link.source_name,\r\n\t\t\t\t\t\t\t\tdestination_name: link.destination_name,\r\n\t\t\t\t\t\t\t\talias: link.source_name + \"::\" + link.destination_name,\r\n\t\t\t\t\t\t\t\ttype: \"circuit\"\r\n\t\t\t\t\t\t\t}));\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t\tself.violatedServices.redraw(self);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (!self.autoRefresh)\r\n\t\t\t\t\tself.setCenter.trigger(self);\r\n\t\t\t},\r\n\t\t\tsetCenter: {\r\n\t\t\t\ttimer: undefined,\r\n\t\t\t\ttrigger: function(that, $center, $zoom) {\r\n\t\t\t\t\tvar map = that.container;\r\n\t\t\t\t\tif (this.timer)\r\n\t\t\t\t\t\t// $timeout.cancel(this.timer);\r\n\t\t\t\t\t\tclearTimeout(this.timer);\r\n\t\t\t\t\t// this.timer = $timeout(function() {\r\n\t\t\t\t\tthis.timer = setTimeout(function() {\r\n\t\t\t\t\t\tvar bounce = ol.animation.bounce({\r\n\t\t\t\t\t\t\tresolution: that.view.getResolution() * 2\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tvar pan = ol.animation.pan({\r\n\t\t\t\t\t\t\tsource: that.view.getCenter()\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tvar zoom = ol.animation.zoom({\r\n\t\t\t\t\t\t\tresolution: that.view.getResolution()\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\t// map.beforeRender(bounce);\r\n\t\t\t\t\t\tmap.beforeRender(pan);\r\n\t\t\t\t\t\tmap.beforeRender(zoom);\r\n\r\n\t\t\t\t\t\tthat.last = {\r\n\t\t\t\t\t\t\tcenter: that.view.getCenter(),\r\n\t\t\t\t\t\t\tzoom: that.view.getZoom()\r\n\t\t\t\t\t\t};\r\n\r\n\t\t\t\t\t\tif ($center) {\r\n\t\t\t\t\t\t\tthat.view.setCenter($center);\r\n\t\t\t\t\t\t\tthat.view.setZoom($zoom || that.view.getZoom());\r\n\t\t\t\t\t\t} else if (that.center) {\r\n\t\t\t\t\t\t\tthat.view.setCenter(that.center);\r\n\t\t\t\t\t\t\tthat.view.setZoom(15);\r\n\t\t\t\t\t\t} else if (that.coordinates) {\r\n\t\t\t\t\t\t\tthat.view.fit(that.coordinates, that.container.getSize());\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tthat.view.setCenter(that.lastDevicePosition);\r\n\t\t\t\t\t\t\tthat.view.setZoom(5);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}, 100);\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\tviolatedServices: {\r\n\t\t\t\tlist: [],\r\n\t\t\t\tgroups: function(map) {\r\n\t\t\t\t\tvar groups = [];\r\n\t\t\t\t\tthis.list.forEach(function(service) {\r\n\t\t\t\t\t\tvar assigned = false;\r\n\t\t\t\t\t\tvar coordinate = ol.proj.transform([service.longtitude, service.latitude], 'EPSG:4326', 'EPSG:3857');\r\n\t\t\t\t\t\tservice.pixel = map.getPixelFromCoordinate(coordinate);\r\n\t\t\t\t\t\tgroups.forEach(function(group) {\r\n\t\t\t\t\t\t\tif (assigned) return;\r\n\t\t\t\t\t\t\tif (service.pixel[0] <= group.pixel[0]+100 && service.pixel[0] > group.pixel[0]-100 && service.pixel[1] <= group.pixel[1]+100 && service.pixel[1] > group.pixel[1]-200) {\r\n\t\t\t\t\t\t\t\tgroup.services[service.type].push(service);\r\n\t\t\t\t\t\t\t\tassigned = true;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tif (!assigned) {\r\n\t\t\t\t\t\t\tvar services = {\r\n\t\t\t\t\t\t\t\tcritical: [],\r\n\t\t\t\t\t\t\t\tmajor: [],\r\n\t\t\t\t\t\t\t\tminor: [],\r\n\t\t\t\t\t\t\t\tinfo: []\r\n\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\tservices[service.type].push(service);\r\n\t\t\t\t\t\t\tvar group = {\r\n\t\t\t\t\t\t\t\tlatitude: service.latitude,\r\n\t\t\t\t\t\t\t\tlongtitude: service.longtitude,\r\n\t\t\t\t\t\t\t\tcoordinate: coordinate,\r\n\t\t\t\t\t\t\t\tpixel: service.pixel,\r\n\t\t\t\t\t\t\t\tservices: services\r\n\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\tgroups.push(group);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t\treturn groups;\r\n\t\t\t\t},\r\n\t\t\t\tredraw: function(that) {\r\n\t\t\t\t\tvar map = that.container;\r\n\t\t\t\t\tif (that.violationSource.getFeatures().length)\r\n\t\t\t\t\t\tthat.violationSource.clear();\r\n\t\t\t\t\tthis.groups(map).forEach(function(group) {\r\n\t\t\t\t\t\tvar index = 0;\r\n\t\t\t\t\t\t[\"critical\", \"major\", \"minor\", \"info\"].forEach(function(type) {\r\n\t\t\t\t\t\t\tgroup.services[type].forEach(function(service) {\r\n\t\t\t\t\t\t\t\tindex += 1;\r\n\t\t\t\t\t\t\t\tif (index > 10) return; // Filter for Groups\r\n\t\t\t\t\t\t\t\tvar geom = new ol.geom.Point(\r\n\t\t\t\t\t\t\t\t\tmap.getCoordinateFromPixel([group.pixel[0], group.pixel[1]+(-15*index)])\r\n\t\t\t\t\t\t\t\t);\r\n\t\t\t\t\t\t\t\tvar feature = new ol.Feature({\r\n\t\t\t\t\t\t\t\t\tgeometry: geom,\r\n\t\t\t\t\t\t\t\t\tcolor: service.color,\r\n\t\t\t\t\t\t\t\t\tname: service.name,\r\n\t\t\t\t\t\t\t\t\tid: service.id\r\n\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t\tfeature.setStyle(that.violationStyle(feature));\r\n\t\t\t\t\t\t\t\tthat.violationSource.addFeature(feature);\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\taddTooltip: function() {\r\n\t\t\t\tvar self = this,\r\n\t\t\t\t\tmap = self.container;\r\n\t\t\t\tvar container = document.getElementById('popup'),\r\n\t\t\t\t\tcontent_element = document.getElementById('popup-content'),\r\n\t\t\t\t\tcloser = document.getElementById('popup-closer');\r\n\r\n\t\t\t\t\tcontainer.style.visibility = \"visible\";\r\n\r\n\t\t\t\tcloser.onclick = closeTooltip;\r\n\t\t\t\tfunction closeTooltip() {\r\n\t\t\t\t\toverlay.setPosition(undefined);\r\n\t\t\t\t\tcloser.blur();\r\n\t\t\t\t\tself.setCenter.trigger(self, self.last.center, self.last.zoom);\r\n\t\t\t\t\treturn false;\r\n\t\t\t\t};\r\n\r\n\t\t\t\tvar overlay = new ol.Overlay({\r\n\t\t\t\t\telement: container,\r\n\t\t\t\t\tautoPan: true,\r\n\t\t\t\t\toffset: [0, -10]\r\n\t\t\t\t});\r\n\t\t\t\tmap.addOverlay(overlay);\r\n\r\n\t\t\t\tmap.on('click', function(event) {\r\n\t\t\t\t\tvar colorMap = {\r\n\t\t\t\t\t\tcircuit: \"black\",\r\n\t\t\t\t\t\tinfo: \"blue\",\r\n\t\t\t\t\t\tminor: \"#f7bb38\",\r\n\t\t\t\t\t\tmajor: \"orange\",\r\n\t\t\t\t\t\tcritical: \"red\"\r\n\t\t\t\t\t};\r\n\r\n\t\t\t\t\tvar devicesInPixel = [],\r\n\t\t\t\t\t\tcircuitsInPixel = [];\r\n\r\n\t\t\t\t\tmap.forEachFeatureAtPixel(event.pixel, function(feature, layer) {\r\n\t\t\t\t\t\tif (layer === self.deviceLayer) {\r\n\t\t\t\t\t\t\tif (!devicesInPixel[feature.get(\"name\")])\r\n\t\t\t\t\t\t\t\tdevicesInPixel[feature.get(\"name\")] = {id: feature.get(\"id\"), coord: feature.getGeometry().getCoordinates()};\r\n\t\t\t\t\t\t} else if (layer === self.violationLayer) {\r\n\t\t\t\t\t\t\t// getCircuit(feature.get(\"id\"));\r\n\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tif (!circuitsInPixel[feature.get(\"alias\")])\r\n\t\t\t\t\t\t\t\tcircuitsInPixel[feature.get(\"alias\")] = {id: feature.get(\"id\"), color: colorMap[feature.get(\"type\")]};\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t\tvar content = \"\";\r\n\t\t\t\t\tif(Object.keys(devicesInPixel).length) {\r\n\r\n\t\t\t\t\t\t// for find deiveces circuits\r\n\t\t\t\t\t\tObject.keys(self.sources).forEach(function(type) {\r\n\t\t\t\t\t\t\tvar features = self.sources[type].getFeatures();\r\n\t\t\t\t\t\t\tfeatures.forEach(function(feature) {\r\n\t\t\t\t\t\t\t\tObject.keys(devicesInPixel).forEach(function(device) {\r\n\t\t\t\t\t\t\t\t\tif (feature.get(\"source_name\") == device || feature.get(\"destination_name\") == device)\r\n\t\t\t\t\t\t\t\t\t\t// if (!circuitsInPixel[feature.get(\"alias\")])\r\n\t\t\t\t\t\t\t\t\t\tcircuitsInPixel[feature.get(\"alias\")] = {id: feature.get(\"id\"), color: colorMap[feature.get(\"type\")]};\r\n\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t});\r\n\r\n\t\t\t\t\t\tcontent += \"<h3>Devices:</h3><ul class='devices'>\";\r\n\t\t\t\t\t\tObject.keys(devicesInPixel).forEach(function(name) {\r\n\t\t\t\t\t\t\tcontent += \"<li data-id='\" + devicesInPixel[name].id + \"' data-coord='\" + devicesInPixel[name].coord + \"'>\" + name + \"</li>\";\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tcontent += \"</ul>\";\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(Object.keys(circuitsInPixel).length) {\r\n\t\t\t\t\t\tcontent += \"<h3>Circuits:</h3><ul class='circuits'>\";\r\n\t\t\t\t\t\tObject.keys(circuitsInPixel).forEach(function(name) {\r\n\t\t\t\t\t\t\tcontent += \"<li style='color: \" + circuitsInPixel[name].color + \"' data-id='\" + circuitsInPixel[name].id + \"'>\" + name + \"</li>\";\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tcontent += \"</ul>\";\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tif(content) {\r\n\t\t\t\t\t\tcontent_element.innerHTML = content;\r\n\t\t\t\t\t\toverlay.setPosition(event.coordinate);\r\n\t\t\t\t\t\tself.setCenter.trigger(self, event.coordinate);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tcloseTooltip();\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\r\n\t\t\t\tfunction getDevice(evt) {\r\n\t\t\t\t\tvar details;\r\n\t\t\t\t\tvar contex = $(this);\r\n\t\t\t\t\tvar coord = contex.data(\"coord\").split(',');\r\n\t\t\t\t\tcoord = [Number(coord[0]), Number(coord[1])];\r\n\t\t\t\t\t\r\n\t\t\t\t\t/* $Ajax.get('device/' + contex.data(\"id\") + '/detail', {}, function(detail) {\r\n\t\t\t\t\t\tvar content = '\\\r\n\t\t\t\t\t\t<div class=\"leaflet-popup-content\" style=\"width: 251px;margin: 0;\">\\\r\n\t\t\t\t\t\t<div class=\"colQuarter\" style=\"color:red;text-align:center;\"><p>Critcal</p><p>' + detail.device.Critical + '</p></div>\\\r\n\t\t\t\t\t\t<div class=\"colQuarter\" style=\"color:orange;text-align:center;\"><p>Major</p><p>' + detail.device.Major + '</p></div>\\\r\n\t\t\t\t\t\t<div class=\"colQuarter\" style=\"color:rgb(185, 185, 0);text-align:center;\"><p>Minor</p><p>' + detail.device.Minor + '</p></div>\\\r\n\t\t\t\t\t\t<div class=\"colQuarter\" style=\"color:blue;text-align:center;\"><p>Info</p><p>' + detail.device.Info + '</p></div>\\\r\n\t\t\t\t\t\t<div class=\"line\"><div class=\"left\"><p>Name :</p></div><div class=\"right\"><p>' + contex.text() + '</p></div></div>\\\r\n\t\t\t\t\t\t<div class=\"line\"><div class=\"left\"><p>Device Serial :</p></div><div class=\"right\"><p>' + detail.device.SerialNumber + '</p></div></div>\\\r\n\t\t\t\t\t\t<div class=\"line\"><div class=\"left\"><p>Hardware Version :</p></div><div class=\"right\"><p>' + detail.device.HardwareVersion + '</p></div></div>\\\r\n\t\t\t\t\t\t<div class=\"line\"><div class=\"left\"><p>SNMP Last Seen Date :</p></div><div class=\"right\"><p>' + detail.device.SnmpLastSeenDate + '</p></div></div>\\\r\n\t\t\t\t\t\t<div class=\"line\"><div class=\"left\"><p>CSV Last Seen Date :</p></div><div class=\"right\"><p>' + detail.device.CsvLastSeenDate + '</p></div></div>\\\r\n\t\t\t\t\t\t<div class=\"clear\"></div></div>';\r\n\r\n\t\t\t\t\t\tcontent_element.innerHTML = content;\r\n\t\t\t\t\t\toverlay.setPosition(coord);\r\n\t\t\t\t\t\tself.setCenter.trigger(self, coord, 8);\r\n\t\t\t\t\t}); */\r\n\t\t\t\t\t\r\n\t\t\t\t\t$.ajax({\r\n\t\t\t\t\t\turl: conf.BASE + \"device/\" + contex.data(\"id\") + \"/detail\" + token(),\r\n\t\t\t\t\t\tmethod: \"GET\",\r\n\t\t\t\t\t})\r\n\t\t\t\t\t.done(detail => {\r\n\t\t\t\t\t\tvar content = '\\\r\n\t\t\t\t\t\t\t<div class=\"leaflet-popup-content\" style=\"width: 251px;margin: 0;\">\\\r\n\t\t\t\t\t\t\t<div class=\"colQuarter\" style=\"color:red;text-align:center;\"><p>Critcal</p><p>' + detail.device.Critical + '</p></div>\\\r\n\t\t\t\t\t\t\t<div class=\"colQuarter\" style=\"color:orange;text-align:center;\"><p>Major</p><p>' + detail.device.Major + '</p></div>\\\r\n\t\t\t\t\t\t\t<div class=\"colQuarter\" style=\"color:rgb(185, 185, 0);text-align:center;\"><p>Minor</p><p>' + detail.device.Minor + '</p></div>\\\r\n\t\t\t\t\t\t\t<div class=\"colQuarter\" style=\"color:blue;text-align:center;\"><p>Info</p><p>' + detail.device.Info + '</p></div>\\\r\n\t\t\t\t\t\t\t<div class=\"line\"><div class=\"left\"><p>Name :</p></div><div class=\"right\"><p>' + contex.text() + '</p></div></div>\\\r\n\t\t\t\t\t\t\t<div class=\"line\"><div class=\"left\"><p>Device Serial :</p></div><div class=\"right\"><p>' + detail.device.SerialNumber + '</p></div></div>\\\r\n\t\t\t\t\t\t\t<div class=\"line\"><div class=\"left\"><p>Hardware Version :</p></div><div class=\"right\"><p>' + detail.device.HardwareVersion + '</p></div></div>\\\r\n\t\t\t\t\t\t\t<div class=\"line\"><div class=\"left\"><p>SNMP Last Seen Date :</p></div><div class=\"right\"><p>' + detail.device.SnmpLastSeenDate + '</p></div></div>\\\r\n\t\t\t\t\t\t\t<div class=\"line\"><div class=\"left\"><p>CSV Last Seen Date :</p></div><div class=\"right\"><p>' + detail.device.CsvLastSeenDate + '</p></div></div>\\\r\n\t\t\t\t\t\t\t<div class=\"clear\"></div></div>';\r\n\r\n\t\t\t\t\t\tcontent_element.innerHTML = content;\r\n\t\t\t\t\t\toverlay.setPosition(coord);\r\n\t\t\t\t\t\tself.setCenter.trigger(self, coord, 8);\r\n\t\t\t\t\t})\r\n\t\t\t\t\t.fail(x => {\r\n\t\t\t\t\t\tif (x.status === 403) {\r\n\t\t\t\t\t\t\tthis.events.emit(\"login_error\");\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tthis.events.emit(\"detail_fail\");\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t\t$(\"#popup-content\").on(\"click\", \".devices li\", getDevice);\r\n\r\n\t\t\t\tfunction getCircuit() {\r\n\t\t\t\t\tcircuitID = $(this).data(\"id\");\r\n\t\t\t\t\t$location.path('/device/circuit/view/' + circuitID);\r\n\t\t\t\t}\r\n\t\t\t\t$(\"#popup-content\").on(\"click\", \".circuits li\", getCircuit);\r\n\t\t\t},\r\n\t\t\taddPanel: function() {\r\n\t\t\t\tvar map = this.container;\r\n\t\t\t\tvar fullscreen = new ol.control.FullScreen();\r\n\t\t\t\tmap.addControl(fullscreen);\r\n\t\t\t},\r\n\t\t\tzoomEvent: function() {\r\n\t\t\t\tvar self = this;\r\n\t\t\t\tvar map = this.container;\r\n\t\t\t\tvar lastZoomLevel = self.view.getZoom();\r\n\t\t\t\tmap.on('moveend', function(event) {\r\n\t\t\t\t\tif (lastZoomLevel != self.view.getZoom()) {\r\n\t\t\t\t\t\tlastZoomLevel = self.view.getZoom();\r\n\t\t\t\t\t\tself.violatedServices.redraw(self);\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t},\r\n\t\t\tsetPointer: function() {\r\n\t\t\t\tvar self = this;\r\n\t\t\t\tvar map = this.container;\r\n\t\t\t\tmap.on('pointermove', function(event) {\r\n\t\t\t\t\tif (event.dragging) return;\r\n\r\n\t\t\t\t\t// TODO: just for Devices and Circuits\r\n\t\t\t\t\tvar isDevice = map.forEachFeatureAtPixel(event.pixel, function(feature, layer) {\r\n\t\t\t\t\t\tif (layer !== self.violationLayer)\r\n\t\t\t\t\t\t\treturn true;\r\n\t\t\t\t\t});\r\n\t\t\t\t\tmap.getTarget().style.cursor = isDevice ? 'pointer' : '';;\r\n\r\n\t\t\t\t\t// TODO: for all features\r\n\t\t\t\t\t// var pixel = map.getEventPixel(event.originalEvent);\r\n\t\t\t\t\t// var hit = map.hasFeatureAtPixel(pixel);\r\n\t\t\t\t\t// map.getTarget().style.cursor = hit ? 'pointer' : '';\r\n\t\t\t\t});\r\n\t\t\t},\r\n\t\t\tgetData: function(params) {\r\n\t\t\t\tvar self = this;\r\n\t\t\t\tparams = params ? params : {};\r\n\t\t\t\tvar page = params.page ? params.page : 1;\r\n\t\t\t\tvar allowClear = params.loop === true ? false : true;\r\n\r\n\t\t\t\t/* var device_ids = function() {\r\n\t\t\t\t\tvar array = [];\r\n\t\t\t\t\tif ($($scope.console.deviceSelectElement).val())\r\n\t\t\t\t\t\t$($scope.console.deviceSelectElement).val().split(\",\").forEach(function(item) {\r\n\t\t\t\t\t\t\tarray.push(Number(item));\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\treturn JSON.stringify(array);\r\n\t\t\t\t}; */\r\n\r\n\t\t\t   /*  $Ajax.post('device/map/data', {\r\n\t\t\t\t\tgroup_ids: JSON.stringify($scope.console.selectedGroupIDs),\r\n\t\t\t\t\tdevice_ids: device_ids(),\r\n\t\t\t\t\tGET: {\r\n\t\t\t\t\t\tpage: page,\r\n\t\t\t\t\t\tviolated: self.isViolated,\r\n\t\t\t\t\t\tlive: self.live\r\n\t\t\t\t\t}\r\n\t\t\t\t}, function(data) {\r\n\t\t\t\t\tif (page < data.total_pages) {\r\n\t\t\t\t\t\tself.addDataToMap(data, allowClear);\r\n\t\t\t\t\t\tself.getData({\r\n\t\t\t\t\t\t\tpage: page += 1,\r\n\t\t\t\t\t\t\tloop: true\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tself.addDataToMap(data, allowClear);\r\n\t\t\t\t}); */\r\n\t\t\t\t\r\n\t\t\t\t/* var THE_DATA = {\r\n\t\t\t\t\tgroup_ids: JSON.stringify([47, 78, 103, 200, 229, 230, 238, 239, 240, 7]),\r\n\t\t\t\t\tdevice_ids: JSON.stringify([529, 1330557, 1643890, 1643889])\r\n\t\t\t\t}; */\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\tlet o = this.toSend;\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\tlet data = {};\r\n\t\t\t\tlet d = o.devices;\r\n\t\t\t\tif (o.groups) data.group_ids = JSON.stringify( o.groups );\r\n\t\t\t\tif (d) data.device_ids = JSON.stringify( Object.keys(d).map(k => d[k].id) );\r\n\t\t\t\tlet append = \"&page=1\";\r\n\t\t\t\tappend += o.violated ? \"&violated=true\" : \"\";\r\n\t\t\t\tappend += o.live     ? \"&live=true\"     : \"\";\r\n\t\t\t\tthis.events.emit(\"data_start\");\r\n\t\t\t\t$.ajax({\r\n\t\t\t\t\turl: conf.BASE + \"device/map/data\" + token() + append, // &violated=true &live=true\r\n\t\t\t\t\tmethod: \"POST\",\r\n\t\t\t\t\tcontentType: false,\r\n\t\t\t\t\tprocessData: false,\r\n\t\t\t\t\tdata: buildFormdata(data),\r\n\t\t\t\t})\r\n\t\t\t\t.done(data => {\r\n\t\t\t\t\tthis.events.emit(\"data_succ\");\r\n\t\t\t\t\tif (page < data.total_pages) {\r\n\t\t\t\t\t\t// self.addDataToMap(data, allowClear);\r\n\t\t\t\t\t\tprocessData(data, allowClear, self);\r\n\t\t\t\t\t\tself.getData({\r\n\t\t\t\t\t\t\tpage: page += 1,\r\n\t\t\t\t\t\t\tloop: true\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tself.addDataToMap(data, allowClear);\r\n\t\t\t\t})\r\n\t\t\t\t.fail(x => {\r\n\t\t\t\t\tif (x.status === 403) {\r\n\t\t\t\t\t\tthis.events.emit(\"login_error\");\r\n\t\t\t\t\t}\r\n\t\t\t\t\tthis.events.emit(\"data_fail\");\r\n\t\t\t\t})\r\n\t\t\t\t.always( () => this.events.emit(\"data_always\") );\r\n\r\n\t\t\t},\r\n\t\t\tmakeMap: function() {\r\n\t\t\t\tvar self = this;\r\n\r\n\t\t\t\tvar layers = [\r\n\t\t\t\t\tnew ol.layer.Tile({\r\n\t\t\t\t\t\tsource: new ol.source.OSM({\r\n\t\t\t\t\t\t\twrapX: true\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t}),\r\n\t\t\t\t\tself.violationLayer,\r\n\t\t\t\t\tself.deviceLayer\r\n\t\t\t\t];\r\n\r\n\t\t\t\t$.each(self.layers, function(key, layer) {\r\n\t\t\t\t\tlayer.setSource(self.sources[key]);\r\n\t\t\t\t\tlayer.setStyle(self.lineStyle(key));\r\n\t\t\t\t\tlayers.push(layer);\r\n\t\t\t\t});\r\n\r\n\t\t\t\tself.container = new ol.Map({\r\n\t\t\t\t\tlayers: layers,\r\n\t\t\t\t\ttarget: self.target,\r\n\t\t\t\t\tcontrols: ol.control.defaults({\r\n\t\t\t\t\t\tattributionOptions: ({\r\n\t\t\t\t\t\t\tcollapsible: false\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t}),\r\n\t\t\t\t\tview: self.view\r\n\t\t\t\t});\r\n\t\t\t\tself.deviceLayer.setSource(self.deviceSource);\r\n\t\t\t\tself.deviceLayer.setStyle(self.deviceStyle);\r\n\t\t\t\tself.deviceLayer.setZIndex(10);\r\n\r\n\t\t\t\tself.violationLayer.setSource(self.violationSource);\r\n\t\t\t\tself.violationLayer.setZIndex(20);\r\n\r\n\t\t\t\t// TODO: optional (use as a feauture)\r\n\t\t\t\tself.layers.circuit.setZIndex(0);\r\n\t\t\t\tself.layers.info.setZIndex(1);\r\n\t\t\t\tself.layers.minor.setZIndex(2);\r\n\t\t\t\tself.layers.major.setZIndex(3);\r\n\t\t\t\tself.layers.critical.setZIndex(4);\r\n\t\t\t},\r\n\t\t\tinit: function(load) {\r\n\t\t\t\tvar self = this;\r\n\t\t\t\t\r\n\t\t\t\tself.makeMap();\r\n\t\t\t\tif (load) self.getData();\r\n\t\t\t\tself.setPointer();\r\n\t\t\t\tself.zoomEvent();\r\n\t\t\t\tself.addTooltip();\r\n\t\t\t\t// self.addPanel();\r\n\t\t\t},\r\n\t\t};\r\n\t}\r\n\t\r\n\tinst.newMap = newMap;\r\n\treturn inst;\r\n});"]}
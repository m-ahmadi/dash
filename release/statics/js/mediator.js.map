{"version":3,"sources":["../../../src/js/mediator.js"],"names":["define","conf","token","login","uk","header","toolbar","wizard","confirm","process","widget","inst","u","extend","newPubSub","ROOT","MSG","widgets","_WIDGETS_","els","processNote","ori","WAIT_TIME","counter","timer","timeout","refreshAll","Object","keys","forEach","k","setTimeout","refresh","autoRefresh","interval","cancelTimeout","clearTimeout","fetchAllFail","doing","log","fetchAll","onNoWidgets","finish","open","inc","randInt","$","ajax","url","ALT","LOAD","method","dataType","cashe","done","isEmptyObj","data","len","objLength","step","get","sorted","push","order","sort","w","i","id","create","close","fail","stat","x","status","start","resume","always","save","contentType","JSON","stringify","onLoginErr","cb","css","el","prop","isStr","parseInt","slice","adjustHeight","root","avail","window","innerHeight","doAll","action","addCustomEvt","on","e","fn","note","error","update","remove","find","each","l","d","expand","min","s","key","val","sortable","edit","children","length","setGlobalTZ","offset","beforeReady","fetchGroups","onReady","getEls","items","handle","delay","opacity","distance","revert","scroll","tolerance","init","adjust","ws"],"mappings":"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","file":"mediator.js","sourcesContent":["define([\r\n\t\"core/config\",\r\n\t\"core/token\",\r\n\t\"login\",\r\n\t\"core/uk\",\r\n\t\"header\",\r\n\t\"./toolbar\",\r\n\t\"./wizard/wizard\",\r\n\t\"./confirm\",\r\n\t\"./process\",\r\n\t\"./widget/widget\"\r\n], (\r\n\tconf,\r\n\ttoken,\r\n\tlogin,\r\n\tuk,\r\n\theader,\r\n\ttoolbar,\r\n\twizard,\r\n\tconfirm,\r\n\tprocess,\r\n\twidget\r\n) => {\r\n\tconst inst = u.extend( newPubSub() );\r\n\tconst ROOT = \"[data-root='content']\";\r\n\tconst MSG = [\r\n\t\t\"Processing your request...\",\r\n\t\t\"Fetching your widgets...\"\r\n\t];\r\n\tlet widgets = {};\r\n\tlet _WIDGETS_ = {};\r\n\tlet els, processNote;\r\n\t\r\n\t/* function viewport() {\r\n\t\tconst w = window.innerWidth;\r\n\t\treturn w > 0     && w < 640   ? 0 :\r\n\t\t\t   w >= 640  && w <= 960  ? 0 :\r\n\t\t\t   w >= 960  && w <= 1200 ? 1 :\r\n\t\t\t   w >= 1200 && w <= 1600 ? 2 :\r\n\t\t\t   w >= 1600 ? 3 : false;\r\n\t} */\r\n\t\r\n\tconst ori = [\"\", \"st\",\"nd\",\"rd\",\"th\",\"th\",\"th\",\"th\",\"th\",\"th\"];\r\n\tconst WAIT_TIME = 400;\r\n\tlet counter = 1;\r\n\tlet timer,\r\n\t\ttimeout = 0;\r\n\t\r\n\tfunction refreshAll() {\r\n\t\tObject.keys(widgets).forEach(k => {\r\n\t\t\tlet widget = widgets[k];\r\n\t\t\tsetTimeout( widget.refresh, (timeout+=WAIT_TIME) );\r\n\t\t});\r\n\t}\r\n\tfunction autoRefresh(interval) {\r\n\t\ttimer = setTimeout(() => {\r\n\t\t\trefreshAll();\r\n\t\t\tautoRefresh(interval);\r\n\t\t}, interval);\r\n\t}\r\n\tfunction cancelTimeout() {\r\n\t\tclearTimeout(timer);\r\n\t}\r\n\tfunction fetchAllFail() {\r\n\t\tif (counter > 1) {\r\n\t\t\tprocess.doing(` (${counter}${ori[counter]} attempt)`, true);\r\n\t\t}\r\n\t\tcounter += 1;\r\n\t\tprocess.log(\"Fetching widget list failed.\", \"danger\");\r\n\t\tif (counter > 3) {\r\n\t\t\tprocess.log(\"Aborted.\", \"danger\");\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tsetTimeout(fetchAll, 1000);\r\n\t}\r\n\tfunction onNoWidgets() {\r\n\t\tprocess.finish();\r\n\t\tprocess.log(\"No widgets to fetch\", \"primary\");\r\n\t}\r\n\tfunction fetchAll() {\r\n\t\tlet timer;\r\n\t\tif (counter === 1) {\r\n\t\t\tprocess.open();\r\n\t\t\tprocess.inc( u.randInt(5, 15) );\r\n\t\t}\r\n\t\tprocess.doing(\"Fetching widget list.\");\r\n\t\t$.ajax({\r\n\t\t\turl: conf.ALT + conf.LOAD + token(),\r\n\t\t\tmethod: \"GET\",\r\n\t\t\tdataType: \"json\",\r\n\t\t\tcashe: false\r\n\t\t})\r\n\t\t.done( data => {\r\n\t\t\tif ( u.isEmptyObj(data) ) {\r\n\t\t\t\tonNoWidgets();\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\t_WIDGETS_ = data;\r\n\t\t\tconst len = u.objLength(data);\r\n\t\t\tprocess.log(`Found ${len} widgets.`, \"success\");\r\n\t\t\tprocess.doing(\"Creating widgets.\");\r\n\t\t\t\r\n\t\t\tlet step = 100 - process.get() / len;\r\n\t\t\tlet sorted = [];\r\n\t\t\tObject.keys(data).forEach(k => {\r\n\t\t\t\tprocess.inc(2);\r\n\t\t\t\tsorted.push([data[k].order, k]);\r\n\t\t\t});\r\n\t\t\tsorted.sort();\r\n\t\t\tsorted.forEach(i => {\r\n\t\t\t\tlet w = data[ i[1] ];\r\n\t\t\t\tprocess.inc(step);\r\n\t\t\t\twidgets[w.id] = widget.create(els.widgets, w);\r\n\t\t\t});\r\n\t\t\tprocess.log(\"Finished.\", \"success\");\r\n\t\t\tprocess.close();\r\n\t\t})\r\n\t\t.fail(x => {\r\n\t\t\tlet stat = x.status;\r\n\t\t\tif ( stat === 403 ) {\r\n\t\t\t\tlogin.start(() => {\r\n\t\t\t\t\tprocess.resume();\r\n\t\t\t\t\tfetchAllFail();\r\n\t\t\t\t});\r\n\t\t\t} else if ( stat === 404 ) {\r\n\t\t\t\tonNoWidgets();\r\n\t\t\t} else {\r\n\t\t\t\tfetchAllFail();\r\n\t\t\t}\r\n\t\t})\r\n\t\t.always();\r\n\t}\r\n\tfunction save(done, fail, always) {\r\n\t\t$.ajax({\r\n\t\t\turl: conf.ALT + \"dashboard/save\" + token(), // \"widget/add\",\r\n\t\t\tmethod: \"POST\",\r\n\t\t\tcontentType: \"application/json\",\r\n\t\t\tdata: JSON.stringify(_WIDGETS_)\r\n\t\t})\r\n\t\t.done(done)\r\n\t\t.fail( x => {\r\n\t\t\tlet stat = x.status;\r\n\t\t\tstat === 403 ? login.start(fail) : fail();\r\n\t\t})\r\n\t\t.always(always);\r\n\t}\r\n\tfunction onLoginErr(cb) {\r\n\t\tlogin.start(cb);\r\n\t}\r\n\tfunction css(el, prop) {\r\n\t\tel = u.isStr(el) ? $(el) : el;\r\n\t\treturn parseInt( el.css(prop).slice(0, -2), 10 );\r\n\t}\r\n\tfunction adjustHeight() {\r\n\t\tlet el = els.root;\r\n\t\t// let h = css(el, \"min-height\");\r\n\t\tlet avail = window.innerHeight - ( css(\"#heading\", \"height\") + css(\"#footer\", \"height\") );\r\n\t\tel.css(\"min-height\", avail);\r\n\t}\r\n\tfunction doAll(action) {\r\n\t\tif ( !u.isEmptyObj(widgets) ) {\r\n\t\t\tObject.keys(widgets).forEach( k => widgets[k][action]() );\r\n\t\t}\r\n\t}\r\n\t\r\n\tfunction addCustomEvt() {\r\n\t\twizard.on(\"submit:create\", (e, fn) => {\r\n\t\t\tprocessNote = uk.note.process(MSG[0], 0, \"top-center\");\r\n\t\t\t_WIDGETS_[e.id] = e;\r\n\t\t\tsave(() => {\r\n\t\t\t\twidgets[e.id] = widget.create(els.widgets, e);\r\n\t\t\t\tfn(true);\r\n\t\t\t\tprocessNote.close();\r\n\t\t\t}, () => {\r\n\t\t\t\tfn(false);\r\n\t\t\t\tprocessNote.close();\r\n\t\t\t\tuk.note.error(\"Could not create the widget. Try again.\");\r\n\t\t\t});\r\n\t\t});\r\n\t\twizard.on(\"submit:edit\", (e, fn) => {\r\n\t\t\tprocessNote = uk.note.process(MSG[0], 0, \"top-center\");\r\n\t\t\t_WIDGETS_[e.id] = e;\r\n\t\t\tsave(() => {\r\n\t\t\t\twidgets[e.id].update(e);\r\n\t\t\t\tfn(true);\r\n\t\t\t\tprocessNote.close();\r\n\t\t\t}, () => {\r\n\t\t\t\tfn(false);\r\n\t\t\t\tprocessNote.close();\r\n\t\t\t\tuk.note.error(\"Could not edit the widget. Try again.\");\r\n\t\t\t});\r\n\t\t});\r\n\t\tconfirm.on(\"submit\", (id, fn) => {\r\n\t\t\tlet cb;\r\n\t\t\tprocessNote = uk.note.process(MSG[0], 0, \"top-center\");\r\n\t\t\t\r\n\t\t\tif (id === \"delete_all\") {\r\n\t\t\t\t_WIDGETS_ = {};\r\n\t\t\t\tcb = () => {\r\n\t\t\t\t\tObject.keys(widgets).forEach(k => widgets[k].remove());\r\n\t\t\t\t\twidgets = {};\r\n\t\t\t\t};\r\n\t\t\t} else if (id === \"save_all\") {\r\n\t\t\t\t\r\n\t\t\t\tels.widgets.find(\"> div\").each((i, l) => {\r\n\t\t\t\t\tlet d = $(l).data();\r\n\t\t\t\t\t_WIDGETS_[d.id].order = i;\r\n\t\t\t\t\t_WIDGETS_[d.id].expand = parseInt(d.expand);\r\n\t\t\t\t\t_WIDGETS_[d.id].min = d.min;\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tdelete _WIDGETS_[id];\r\n\t\t\t\tcb = () => {\r\n\t\t\t\t\twidgets[id].remove();\r\n\t\t\t\t\tdelete widgets[id];\r\n\t\t\t\t};\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tsave(() => {\r\n\t\t\t\tif (cb) cb();\r\n\t\t\t\tprocessNote.close();\r\n\t\t\t\tfn();\r\n\t\t\t}, () => {\r\n\t\t\t\tfn();\r\n\t\t\t\tuk.note.error(\"Couldn't remove the widget.\");\r\n\t\t\t\tprocessNote.close();\r\n\t\t\t});\r\n\t\t});\r\n\t\twizard.on(\"login_error\", onLoginErr);\r\n\t\twidget.on(\"login_error\", onLoginErr);\r\n\t\twidget.on(\"save_signal\", e => {\r\n\t\t\tlet s = e.action;\r\n\t\t\tif (s === \"create\") {\r\n\t\t\t\t\r\n\t\t\t} else if (s === \"edit\") {\r\n\t\t\t\r\n\t\t\t\t_WIDGETS_[e.id][e.key] = e.val;\r\n\t\t\t\t\r\n\t\t\t} else if (s === \"delete\") {\r\n\t\t\t\t\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tsave(e.done, e.fail);\r\n\t\t});\r\n\t\twidget.on(\"create_node\", (id, widget)=> {\r\n\t\t\twidgets[id] = widget;\r\n\t\t\tels.widgets.sortable(\"refresh\");\r\n\t\t});\r\n\t\twidget.on(\"delete\", id => {\r\n\t\t\tconfirm.open(id);\r\n\t\t});\r\n\t\twidget.on(\"edit\", e => {\r\n\t\t\twizard.edit(e);\r\n\t\t});\r\n\t\t\r\n\t\ttoolbar\r\n\t\t\t.on( \"add\", () => wizard.start( els.widgets.children().length ) )\r\n\t\t\t.on(\"save_all\", () => {\r\n\t\t\t\tif ( !u.isEmptyObj(widgets) ) {\r\n\t\t\t\t\tconfirm.open(\"save_all\");\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t\t.on(\"delete_all\", () => {\r\n\t\t\t\tif ( !u.isEmptyObj(widgets) ) {\r\n\t\t\t\t\tconfirm.open(\"delete_all\");\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t\t.on(\"min_all\", doAll, \"min\")\r\n\t\t\t.on(\"max_all\", doAll, \"max\")\r\n\t\t\t.on(\"shrink_all\", doAll, \"shrink\")\r\n\t\t\t.on(\"expand_all\", doAll, \"expand\")\r\n\t\t\t.on(\"start_auto_refresh\", autoRefresh)\r\n\t\t\t.on(\"end_auto_refresh\", cancelTimeout);\r\n\t\theader.on(\"time\", offset => {\r\n\t\t\t\r\n\t\t\twidget.setGlobalTZ(offset);\r\n\t\t});\r\n\t}\r\n\r\n\t\r\n\tinst.beforeReady = () => {\r\n\t\tif ( token(true) ) {\r\n\t\t\twizard.fetchGroups();\r\n\t\t}\r\n\t};\r\n\tinst.onReady = () => {\r\n\t\tels = u.getEls(ROOT);\r\n\t\tadjustHeight();\r\n\t\t$(window).on(\"resize\", adjustHeight);\r\n\t\tels.widgets.sortable({\r\n\t\t\titems: \"> div\",\r\n\t\t\thandle: \".uk-sortable-handle\",\r\n\t\t\tdelay: 50,\r\n\t\t\topacity: 0.5,\r\n\t\t\tdistance: 5,\r\n\t\t\trevert: 300, // true\r\n\t\t\tscroll: false,\r\n\t\t\ttolerance: \"pointer\"\r\n\t\t//\tplaceholder: \"ui-state-highlight\"\r\n\t\t});\r\n\t\t\r\n\t\t$(window).on(\"beforeunload\", e => {\r\n\t\t\tif (false) { // changed then return\r\n\t\t\t\treturn null;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t});\r\n\t\t\r\n\t\taddCustomEvt();\r\n\t\theader.init();\r\n\t\ttoolbar.init(els.toolbar);\r\n\t\twizard.init();\r\n\t\tconfirm.init();\r\n\t\tprocess.init();\r\n\t\tlogin.init();\r\n\t\twidget.init();\r\n\t\t\r\n\t\tif ( token(true) === false ) {\r\n\t\t\tlogin.start(() => {\r\n\t\t\t\theader.adjust();\r\n\t\t\t\tfetchAll();\r\n\t\t\t\twizard.fetchGroups();\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\theader.adjust();\r\n\t\t\tfetchAll();\r\n\t\t}\r\n\t};\r\n\twindow.ws = () => widgets;\r\n\treturn inst;\r\n});"]}
{"version":3,"sources":["../../../../../src/js/wizard/wiz2/sensors.js"],"names":["define","conf","token","inst","u","extend","newPubSub","temp","getTemps","jsonStr","JSON","stringify","jsonParse","parse","els","serviceId","load","toFilter","Error","btnParent","stat","html","smallSpinner","children","length","empty","$","ajax","url","BASE","method","data","services","done","res","forEach","push","id","i","name","units","available_units","map","v","selected","toggle","filter","reOrder","fail","sensorLoadBtn","sensorLoadDanger","x","status","emit","arr","indexOf","o","el","sensors","appendItem","change","sensor","newOpt","val","attr","text","color","append","remove","find","b","disabled","clear","add","clearReloaders","setServiceId","removeAll","init","els_","on","select2","width","placeholder","minimumInputLength","multiple","s","e","params","element","dataset","parseInt"],"mappings":"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","file":"sensors.js","sourcesContent":["define([\"core/config\", \"core/token\"], (conf, token) => {\r\n\tconst inst = u.extend( newPubSub() );\r\n\tconst temp = u.getTemps(\"wizard/wiz2\");\r\n\tconst jsonStr = JSON.stringify;\r\n\tconst jsonParse = JSON.parse;\r\n\t\r\n\tlet els;\r\n\tlet serviceId;\r\n\t\r\n\tfunction load(toFilter) {\r\n\t\tif (!serviceId) throw new Error(\"wizard/wiz2/sensors.load(): serviceId must be set before loading.\");\r\n\t\tlet { btnParent, stat } = els;\r\n\t\t\r\n\t\tstat.html( temp.smallSpinner() );\r\n\t\tif ( btnParent.children().length ) btnParent.empty();\r\n\t\t$.ajax({\r\n\t\t\turl: conf.BASE + \"device/service/kpilist\" + token(),\r\n\t\t\tmethod: \"POST\",\r\n\t\t\tdata: {\r\n\t\t\t\tservices: jsonStr( [ serviceId ] )\r\n\t\t\t}\r\n\t\t})\r\n\t\t.done(data => {\r\n\t\t\tstat.empty();\r\n\t\t\tlet res = [];\r\n\t\t\tdata.forEach(i => {\r\n\t\t\t\tres.push({\r\n\t\t\t\t\tid: i.id,\r\n\t\t\t\t\tname: i.name,\r\n\t\t\t\t\tunits: i.available_units.map(v => {\r\n\t\t\t\t\t\treturn {\r\n\t\t\t\t\t\t\tname: v,\r\n\t\t\t\t\t\t\tselected: false\r\n\t\t\t\t\t\t};\r\n\t\t\t\t\t})\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t\ttoggle(true);\r\n\t\t\tif (toFilter) {\r\n\t\t\t\tres = filter(res, toFilter);\r\n\t\t\t}\r\n\t\t\treOrder(res);\r\n\t\t})\r\n\t\t.fail(x => {\r\n\t\t\tbtnParent.html( temp.sensorLoadBtn() );\r\n\t\t\tstat.empty().html( temp.sensorLoadDanger() );\r\n\t\t\t\r\n\t\t\tif (x.status === 403) inst.emit(\"login_error\");\r\n\t\t});\r\n\t}\r\n\tfunction filter(arr, toFilter) {\r\n\t\treturn arr.filter(o => toFilter.indexOf(o.id) === -1 );\r\n\t}\r\n\tfunction reOrder(data) {\r\n\t\tlet el = els.sensors;\r\n\t\tel.empty();\r\n\t\tdata.forEach( i => appendItem(i) );\r\n\t\tel.change();\r\n\t}\r\n\tfunction appendItem(sensor) {\r\n\t\tlet newOpt = $(\"<option></option>\")\r\n\t\t\t.val(sensor.id)\r\n\t\t\t.attr( \"data-units\", jsonStr(sensor.units) )\r\n\t\t\t.text(sensor.name);\r\n\t\tlet color = sensor.color;\r\n\t\tif (color) newOpt.attr(\"data-color\", color);\r\n\t\tels.sensors.append(newOpt);\r\n\t}\r\n\tfunction remove(id) {\r\n\t\tels.sensors.find(`option[value='${id}']`).remove().change();\r\n\t\treturn inst;\r\n\t}\r\n\tfunction toggle(b) {\r\n\t\tels.sensors.attr({disabled: !b});\r\n\t\treturn inst;\r\n\t}\r\n\tfunction clear() {\r\n\t\tels.sensors.val(null).change();\r\n\t\treturn inst;\r\n\t}\r\n\t\r\n\tinst.remove = remove;\r\n\tinst.toggle = toggle;\r\n\tinst.clear = clear;\r\n\tinst.load = load;\r\n\t\r\n\tinst.add = (sensor) => {\r\n\t\tappendItem(sensor);\r\n\t\tels.sensors.change();\r\n\t\treturn inst;\r\n\t};\r\n\tinst.clearReloaders = () => {\r\n\t\tels.btnParent.empty();\r\n\t\tels.stat.empty();\r\n\t\treturn inst;\r\n\t};\r\n\tinst.setServiceId = id => {\r\n\t\tserviceId = id;\r\n\t\treturn inst;\r\n\t};\r\n\tinst.removeAll = () => {\r\n\t\tels.sensors.empty().val(null).change();\r\n\t\treturn inst;\r\n\t};\r\n\tinst.init = els_ => {\r\n\t\tels = els_;\r\n\t\t\r\n\t\tels.btnParent.on(\"click\", \"[data-retry]\", load);\r\n\t\t\r\n\t\tels.sensors.select2({\r\n\t\t\twidth: \"100%\",\r\n\t\t\tplaceholder: \"Select sensors\",\r\n\t\t\tdata: [],\r\n\t\t\tminimumInputLength: 0,\r\n\t\t\tdisabled: true,\r\n\t\t\tmultiple: true\r\n\t\t})\r\n\t\t.on(\"select2:select\", e => {\r\n\t\t\tclear();\r\n\t\t\tlet s = e.params.data;\r\n\t\t\tlet data = s.element.dataset;\r\n\t\t\tlet color = data.color;\r\n\t\t\tlet sensor = {\r\n\t\t\t\tid: parseInt(s.id, 10),\r\n\t\t\t\tname: s.text,\r\n\t\t\t\tunits: jsonParse(data.units),\r\n\t\t\t};\r\n\t\t\tif (color) {\r\n\t\t\t\tsensor.color = color;\r\n\t\t\t}\r\n\t\t\tremove(s.id);\r\n\t\t\tinst.emit(\"select\", sensor);\r\n\t\t});\r\n\t\t// we can use a normal select instead of select2.\r\n\t\t// (only downside is searching in the input by typing will no longer be available.)\r\n\t\t/* els.sensors.on(\"change\", e => {\r\n\t\t\tlet data = $(e.target).data();\r\n\t\t\tclear();\r\n\t\t\tlet color = data.color;\r\n\t\t\tlet sensor = {\r\n\t\t\t\tid: parseInt(s.id, 10),\r\n\t\t\t\tname: s.text,\r\n\t\t\t\tunits: jsonParse(data.units),\r\n\t\t\t};\r\n\t\t\tif (color) {\r\n\t\t\t\tsensor.color = color;\r\n\t\t\t}\r\n\t\t\tremove(s.id);\r\n\t\t\tinst.emit(\"select\", sensor);\r\n\t\t}); */\r\n\t};\r\n\t\r\n\treturn inst;\r\n});"]}